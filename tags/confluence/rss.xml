<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>confluence on Log4D</title>
    <link>https://blog.alswl.com/tags/confluence/</link>
    <description>Recent content in confluence on Log4D</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh</language>
    <lastBuildDate>Tue, 12 Jan 2016 22:53:55 +0800</lastBuildDate><atom:link href="https://blog.alswl.com/tags/confluence/rss.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>一次艰难的 Wiki 升级</title>
      <link>https://blog.alswl.com/2016/01/confluence-upgrade/</link>
      <pubDate>Tue, 12 Jan 2016 22:53:55 +0800</pubDate>
      
      <guid>https://blog.alswl.com/2016/01/confluence-upgrade/</guid>
      <description>公司使用 Confluence 管理自己的知识库， 现在使用的版本还是 3.0.1，而最新的 Confluence 版本已经是 5.4+。 新版本加入的一些现代化 Web 系统的新特性很吸引人（拖拽上传，可见即所得编辑）， 在群众的强烈呼声下，我着手开始升级。 官方的升级路线很扯，3.0.1 的升级路线是： 3.0.1 -&amp;gt; 3.5.17 5.0.3 -&amp;gt; 5.4.4 中间两次大版本升级，第一次原因不明，第二次是更新了 markup 渲染引擎， 改为 HTML 格式类型的渲染模式。 由于一些原因，我们系统还跑在 embedded 模式下（其实就是 HyperS</description>
      <content:encoded><![CDATA[<p>公司使用 <a href="https://www.atlassian.com/software/confluence">Confluence</a>
管理自己的知识库，
现在使用的版本还是 3.0.1，而最新的 Confluence 版本已经是 5.4+。
新版本加入的一些现代化 Web 系统的新特性很吸引人（拖拽上传，可见即所得编辑），
在群众的强烈呼声下，我着手开始升级。</p>
<p>




<img loading="lazy" src="https://e25ba8-log4d-c.dijingchao.com/upload_dropbox/201601/confluence_river.jpg" alt="201601/confluence_river.jpg"  />


</p>
<!-- more -->
<p>官方的升级路线很扯，3.0.1 的升级路线是：</p>
<ul>
<li>3.0.1 -&gt; 3.5.17</li>
<li>5.0.3 -&gt; 5.4.4</li>
</ul>
<p>中间两次大版本升级，第一次原因不明，第二次是更新了 markup 渲染引擎，
改为 HTML 格式类型的渲染模式。</p>
<p>由于一些原因，我们系统还跑在 embedded 模式下（其实就是 HyperSQL），这种大版本升级，
需要先从内置库升级到外部数据库，比如 MySQL。</p>
<p>苦逼旅程就开始了。</p>
<h2 id="from-embedded-to-mysql">From embedded to MySQL</h2>
<p>更新内置库到外部库的操作流程：</p>
<ul>
<li>导出当前的数据备份，包括附件，我导出后 1G+</li>
<li>使用当前同版本（3.0.1）安装一个全新的 wiki，注意下载 JDBC-connector</li>
<li>安装之后，配置好 MySQL，开始导入之前准备好的备份</li>
<li>悲剧上演</li>
</ul>
<p>遇到了错误：</p>
<blockquote>
<p>Import failed. Hibernate operation: could not insert: [com.atlassian.confluence.core.BodyContent#12028015]; SQL []; Duplicate entry &lsquo;12028015&rsquo; for key &lsquo;PRIMARY&rsquo;; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Duplicate entry &lsquo;12028015&rsquo; for key &lsquo;PRIMARY&rsquo;</p>
</blockquote>
<p>官方文档 <a href="https://confluence.atlassian.com/doc/troubleshooting-xml-backups-that-fail-on-restore-199034.html">https://confluence.atlassian.com/doc/troubleshooting-xml-backups-that-fail-on-restore-199034.html</a>
让修改重复键数据，好吧，我改，搜索一把重复主键，将备份里面的 <code>entities.xml</code> 弄出来。</p>
<pre tabindex="0"><code># 格式化
awk &#39;{s=s $0}END{gsub(/&gt;&lt;/,&#34;&gt;\n&lt;&#34;,s);s=gensub(/&gt;([^ \n&gt;]*)&lt;/,&#34;&gt;\n\\1\n&lt;&#34;,&#34;g&#34;,s);print s}&#39; entities.xml &gt; entities.xml.format
# 找重复主键 cat entities.xml.format G &#39;content&#34; class=&#34;Page&#39; -A 2 G -E &#39;[0-9]+&#39; | sort | uniq -c | sort -gr L cat entities.xml.format | grep &#39;name=&#34;id&#34;&#39; -A 1 -B 1 | grep -E &#39;[0-9]+&#39; -B 2 L
</code></pre><p>操作过程中，发现有数据就一条数据（grep entities.xml），还是插入重复（13238835）。
官方文档解释是，内置数据库的锁有时候会不灵，插入重复键。
于是决定再试试去掉主键约束方案，大不了那个数据我就不要了。</p>
<pre tabindex="0"><code>ALTER TABLE BODYCONTENT DROP PRIMARY KEY;
</code></pre><p>结果还有其他 PK 约束，我于是一条一条解开，然后……还是不行，真是作了一手的好死。</p>
<p>结论是，这数据错误了太多，已经无法手工修复。</p>
<h2 id="横插一刀的-emoji-">横插一刀的 Emoji 😊😢💗</h2>
<p>导入时候报了这么一个错误：</p>
<blockquote>
<p>Caused by: java.sql.SQLException: Incorrect string value: &lsquo;\xF0\x9F\x8C\x8D\xE5\x9B&hellip;&rsquo; for column &lsquo;BODY&rsquo; at row 1 org.xml.sax.SAXException: Error while parsing 2015-10-19 23:14:13,108 ERROR [Importing data task] [confluence.importexport.impl.ReverseDatabinder] fromXML Error processing backup: &ndash; referer: http://10.1.2.155:8087/setup/setup-restore-start.action | url: /setup/setup-restore-local.action | userName: anonymous | action: setup-restore-local org.xml.sax.SAXException: Error while parsing net.sf.hibernate.exception.GenericJDBCException: could not insert: [com.atlassian.confluence.core.BodyContent#12028161]</p>
</blockquote>
<p>这是 Emoji 编码的问题，理论上 MySQL 换到 5.6+，更新 encoding 就可以了。</p>
<p>但是……Confluence 的建表 SQL 爆出了 255 varchar 超过 1000 限制的错误
，我尝试使用 <a href="https://github.com/rails/rails/issues/9855">innodb_large_prefix</a>
似乎可以解决（因为重复键的问题，导致导入已经行不通）。</p>
<p>另外 innodb_large_prefix 是 5.6.3 才有的，只能升级 MySQL，
并且需要创建表时候使用 DYNAMIC 参数。</p>
<p>弄个 Emoji 这么绕，这导致我直接弃用了 MySQL。</p>
<p>如果是正常迁移，不遇到重复键，Emoji 的问题，可以参考官方的文档，完成平滑迁移：</p>
<ul>
<li><a href="https://confluence.atlassian.com/doc/migrating-to-another-database-148867.html">https://confluence.atlassian.com/doc/migrating-to-another-database-148867.html</a></li>
<li><a href="https://confluence.atlassian.com/doc/database-setup-for-mysql-128747.html">https://confluence.atlassian.com/doc/database-setup-for-mysql-128747.html</a></li>
<li><a href="https://confluence.atlassian.com/doc/upgrading-confluence-4578.html">https://confluence.atlassian.com/doc/upgrading-confluence-4578.html</a></li>
<li><a href="https://confluence.atlassian.com/doc/upgrading-confluence-manually-255363437.html">https://confluence.atlassian.com/doc/upgrading-confluence-manually-255363437.html</a></li>
<li><a href="https://confluence.atlassian.com/conf56/confluence-user-s-guide/creating-content/using-the-editor/using-symbols-emoticons-and-special-characters">https://confluence.atlassian.com/conf56/confluence-user-s-guide/creating-content/using-the-editor/using-symbols-emoticons-and-special-characters</a></li>
</ul>
<h2 id="妈蛋自己干">妈蛋，自己干</h2>
<p>上面这么点东西，陆陆续续花了我两周的时间（晚上）。已经确认走不通平滑迁移，那就别怪我手段糙了。</p>
<p>使用 API 导出后直接导入，这种做法最大问题是不平滑，会丢掉 Wiki 修改的历史记录，
在和各个业务方沟通之后，最后达成了一致：可以暴力升级。</p>
<p>升级流程：</p>
<ul>
<li>准备最新 Confluence 新站点</li>
<li>关停站点</li>
<li>导出数据，包括 Page、评论、附件</li>
<li>导入 Page，评论，附件</li>
<li>启动旧站点，开启只读模式</li>
<li>启用新站点</li>
</ul>
<p>官方有一个 <a href="https://migrations.atlassian.net/wiki">Universal Wiki Converter</a>，
我在 Bitbucket 上面找到了源码，但是已经不可工作了。
虽然宣称「The UWC will however save you 1-2+ weeks of scripting development time, compared with starting from scratch, for many of the most common conversion cases.」
但并没有卵用。</p>
<p>不行就自己随便搞搞好了，看了一下开发需要的 <a href="https://confluence.atlassian.com/display/CONF30/Remote+API+Specification+2.4#RemoteAPISpecification2.4-Page">Conflunce API</a>，
和尤其贴心的新版本 <a href="https://developer.atlassian.com/confdev/confluence-rest-api?continue=https%3A%2F%2Fdeveloper.atlassian.com%2Fconfdev%2Fconfluence-rest-api&amp;application=dac">RESTful API</a>，就开始搞了。</p>
<p>写迁移代码，在这里 <a href="https://github.com/duitang/atlassian-confluence-xxoo">atlassian-confluence-xxoo</a>，已经开源了，只使用过一次，成功的从 3.0.1 迁移到 5.4.4，
理论上，支持任意版本的 3.x/4.x Confluence 迁移到最新。</p>
<p>使用 <code>python app.py -h</code> 查看帮助，不行就看看代码。</p>
<p>希望有迁移需求的同学，搜索到这里能够获得一些帮助。</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
