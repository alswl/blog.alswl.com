<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Ss on Log4D</title>
    <link>https://blog.alswl.com/tags/ss/</link>
    <description>Recent content in Ss on Log4D</description>
    <generator>Hugo -- 0.135.0</generator>
    <language>zh</language>
    <lastBuildDate>Fri, 27 Nov 2015 20:23:24 +0800</lastBuildDate>
    <atom:link href="https://blog.alswl.com/tags/ss/rss.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>SS with Haproxy</title>
      <link>https://blog.alswl.com/2015/11/ss-with-haproxy/</link>
      <pubDate>Fri, 27 Nov 2015 20:23:24 +0800</pubDate>
      <guid>https://blog.alswl.com/2015/11/ss-with-haproxy/</guid>
      <description>&lt;p&gt;




&lt;img loading=&#34;lazy&#34; src=&#34;https://blog.alswl.com/images/upload_dropbox/201512/shadowsocks.png&#34; alt=&#34;shadowsocks.png&#34;  /&gt;


&lt;/p&gt;
&lt;p&gt;以前用自己的 SS，Linode 美国，后来 Linode 日本，但是始终拼不过上海电信的国际带宽。
经常不稳定，丢一半的包。&lt;/p&gt;
&lt;p&gt;于是买了 &lt;a href=&#34;https://portal.shadowsocks.com.hk/aff.php?aff=4215&#34;&gt;SS&lt;/a&gt; 服务，
9 台服务器，自己挑觉得速度快的服务器。&lt;/p&gt;
&lt;p&gt;但一直固定某台服务器也会偶尔出问题，导致邮件出不来，网页打不开。
需要手动切换一下服务器。
于是用 HA 做了一个本地代理，调整了一些参数，让 SS 总是有快速的服务器供选择。&lt;/p&gt;
&lt;p&gt;结构：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;+-----------------+                                                  +----------------+
|                 |                                                  |                |
|    Server 1     |&amp;gt;&amp;gt;&amp;gt;&amp;gt;v                                           &amp;gt;&amp;gt;|   Mail.app     |
|                 |    v                                           ^ |                |
+-----------------+    v                                           ^ +----------------+
                       v                                           ^
+-----------------+    v    |----------------+      +------------+ ^ +----------------+
|                 |    v    |                |      |            | ^ |                |
|    Server 2     |&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;|    HAProxy     |&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;| SS-Client  |&amp;gt;&amp;gt;&amp;gt;|   Browser      |
|                 |    ^    |                |      |            | v |                |
+-----------------+    ^    +----------------+      +------------+ v +----------------+
                       ^                                           v   
+-----------------+    ^                                           v +----------------+
|                 |    ^                                           v |                |
|    Server 3     |&amp;gt;&amp;gt;&amp;gt;&amp;gt;^                                           v&amp;gt;|   Evernote...  |
|                 |                                                  |                |
+-----------------+                                                  +----------------+
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;配置：&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>




<img loading="lazy" src="https://e25ba8-log4d-c.dijingchao.com/upload_dropbox/201512/shadowsocks.png" alt="shadowsocks.png"  />


</p>
<p>以前用自己的 SS，Linode 美国，后来 Linode 日本，但是始终拼不过上海电信的国际带宽。
经常不稳定，丢一半的包。</p>
<p>于是买了 <a href="https://portal.shadowsocks.com.hk/aff.php?aff=4215">SS</a> 服务，
9 台服务器，自己挑觉得速度快的服务器。</p>
<p>但一直固定某台服务器也会偶尔出问题，导致邮件出不来，网页打不开。
需要手动切换一下服务器。
于是用 HA 做了一个本地代理，调整了一些参数，让 SS 总是有快速的服务器供选择。</p>
<p>结构：</p>
<pre tabindex="0"><code>+-----------------+                                                  +----------------+
|                 |                                                  |                |
|    Server 1     |&gt;&gt;&gt;&gt;v                                           &gt;&gt;|   Mail.app     |
|                 |    v                                           ^ |                |
+-----------------+    v                                           ^ +----------------+
                       v                                           ^
+-----------------+    v    |----------------+      +------------+ ^ +----------------+
|                 |    v    |                |      |            | ^ |                |
|    Server 2     |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|    HAProxy     |&gt;&gt;&gt;&gt;&gt;&gt;| SS-Client  |&gt;&gt;&gt;|   Browser      |
|                 |    ^    |                |      |            | v |                |
+-----------------+    ^    +----------------+      +------------+ v +----------------+
                       ^                                           v   
+-----------------+    ^                                           v +----------------+
|                 |    ^                                           v |                |
|    Server 3     |&gt;&gt;&gt;&gt;^                                           v&gt;|   Evernote...  |
|                 |                                                  |                |
+-----------------+                                                  +----------------+
</code></pre><p>配置：</p>
<pre tabindex="0"><code>global
    ulimit-n  4096


defaults
    log global
    mode    tcp
    timeout connect 1s
    timeout client 1s
    timeout server 1s


listen stats
    bind 127.0.0.1:12222
    mode http
    stats enable
    stats uri /
    stats refresh 8s


listen ss
    bind 127.0.0.1:1081
    mode tcp
    option tcpka
    #balance source
    balance roundrobin
    log global
    maxconn 1024

    timeout connect 200ms
    timeout client 600s
    timeout server 600s
    timeout check 80ms  # for office / home
    # timeout check 400ms  # for starbucks
    retries 1
    option redispatch
    option tcp-check

    server s1 host1:port maxconn 20 check inter 2s rise 30 fall 6 backup
    server s2 host2:port maxconn 20 check inter 2s rise 30 fall 6
    server s3 host2:port maxconn 20 check inter 1s rise 60 fall 6
</code></pre><p>挺稳定，很快速。</p>
<p>update: 2015-12-15，添加 <code>backup</code> 项，选一台最稳定的做 backup，避免所有连接都超时。
update: 2015-12-13，添加 <code>redispatch</code>  / <code>retries</code> 项，换机器重试，
大幅提高可用性，注意，可能在非幂等状态下面产生未知错误。</p>
<p>




<img loading="lazy" src="https://e25ba8-log4d-c.dijingchao.com/upload_dropbox/201512/haproxy.png" alt="haproxy.png"  />


</p>
<p>在跑的 node，有些延迟高，被干掉了。</p>
<p>




<img loading="lazy" src="https://e25ba8-log4d-c.dijingchao.com/upload_dropbox/201512/youtube.png" alt="youtube.png"  />


</p>
<p>看 1080P 也挺顺畅。</p>
]]></content:encoded>
    </item>
  </channel>
</rss>
