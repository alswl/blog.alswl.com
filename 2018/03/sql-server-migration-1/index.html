<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>从 SQL Server 到 MySQL（一）：异构数据库迁移 | Log4D</title>
<meta name="keywords" content="sqlserver, mysql, db-migration">
<meta name="description" content="该系列三篇文章已经全部完成： 从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D 背景 沪江成立于 2001 年，作为较早期的教育学习网站， 当时技术选型范围并不大： Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购， 版本号是 3.23。 工程师们选择了当时最合适的微软体系，并在日后的岁月里， 逐步从 ASP 过度到 .net，数据">
<meta name="author" content="alswl">
<link rel="canonical" href="https://blog.alswl.com/2018/03/sql-server-migration-1/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.1e921941d042e4ad5e05d67c1a0a128f1f4c7e7ee7732232f47971a00b164bf3.css" integrity="sha256-HpIZQdBC5K1eBdZ8GgoSjx9Mfn7ncyIy9HlxoAsWS/M=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.alswl.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.alswl.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.alswl.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.alswl.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.alswl.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-8822123-3', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="从 SQL Server 到 MySQL（一）：异构数据库迁移" />
<meta property="og:description" content="该系列三篇文章已经全部完成： 从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D 背景 沪江成立于 2001 年，作为较早期的教育学习网站， 当时技术选型范围并不大： Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购， 版本号是 3.23。 工程师们选择了当时最合适的微软体系，并在日后的岁月里， 逐步从 ASP 过度到 .net，数据" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.alswl.com/2018/03/sql-server-migration-1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-03-12T21:08:56+08:00" />
<meta property="article:modified_time" content="2018-03-12T21:08:56+08:00" /><meta property="og:site_name" content="Log4D" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="从 SQL Server 到 MySQL（一）：异构数据库迁移"/>
<meta name="twitter:description" content="该系列三篇文章已经全部完成： 从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D 背景 沪江成立于 2001 年，作为较早期的教育学习网站， 当时技术选型范围并不大： Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购， 版本号是 3.23。 工程师们选择了当时最合适的微软体系，并在日后的岁月里， 逐步从 ASP 过度到 .net，数据"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://blog.alswl.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "从 SQL Server 到 MySQL（一）：异构数据库迁移",
      "item": "https://blog.alswl.com/2018/03/sql-server-migration-1/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "从 SQL Server 到 MySQL（一）：异构数据库迁移",
  "name": "从 SQL Server 到 MySQL（一）：异构数据库迁移",
  "description": "该系列三篇文章已经全部完成： 从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D 背景 沪江成立于 2001 年，作为较早期的教育学习网站， 当时技术选型范围并不大： Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购， 版本号是 3.23。 工程师们选择了当时最合适的微软体系，并在日后的岁月里， 逐步从 ASP 过度到 .net，数据",
  "keywords": [
    "sqlserver", "mysql", "db-migration"
  ],
  "articleBody": "该系列三篇文章已经全部完成：\n从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D 背景 沪江成立于 2001 年，作为较早期的教育学习网站， 当时技术选型范围并不大： Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购， 版本号是 3.23。 工程师们选择了当时最合适的微软体系，并在日后的岁月里， 逐步从 ASP 过度到 .net，数据库也跟随 SQL Server 进行版本升级。\n十几年过去了，技术社区已经发生了天翻地覆的变化。 沪江的技术栈还基本在 .net 体系上，这给业务持续发展带来了一些限制。 人才招聘、社区生态、架构优化、成本风险方面都面临挑战。 集团经过慎重考虑，发起了大规模的去 Windows 化项目。 这其中包含两个重点子项目：开发语言从 C# 迁移到 Java， 数据库从 SQL Server 迁移到 MySQL。\n本系列文章就是向大家介绍， 从 SQL Server 迁移到 MySQL 所面临的问题和我们的解决方案。\n迁移方案的基本流程 设计迁移方案需要考量以下几个指标：\n迁移前后的数据一致性 业务停机时间 迁移项目是否对业务代码有侵入 需要提供额外的功能：表结构重构、字段调整 经过仔细调研，在平衡复杂性和业务方需求后， 迁移方案设计为两种：停机数据迁移和在线数据迁移。 如果业务场景允许数小时的停机，那么使用停机迁移方案， 复杂度低，数据损失风险低。 如果业务场景不允许长时间停机，或者迁移数据量过大， 无法在几个小时内迁移完成，那么就需要使用在线迁移方案了。\n数据库停机迁移的流程：\n停机迁移逻辑比较简单，使用 ETL（Extract Translate Load） 工具从 Source 写入 Target，然后进行一致性校验，最后确认应用运行 OK， 将 Source 表名改掉进行备份。\n在线迁移的流程：\n在线迁移的方案稍微复杂一些，流程上有准备全量数据，然后实时同步增量数据， 在数据同步跟上（延迟秒级别）之后，进行短暂停机（Hang 住，确保没有流量）， 就可以使用新的应用配置，并使用新的数据库。\n需要解决的问题 从 SQL Server 迁移到 MySQL，核心是完成异构数据库的迁移。\n基于两种数据迁移方案，我们需要解决以下问题：\n两个数据库的数据结构是否可以一一对应？出现不一致如何处理？ MySQL 的使用方式和 SQL Server 使用方式是否一致？有哪些地方需要注意？ 如何确保迁移前后的数据一致性？ 在迁移中，如何支持数据结构调整？ 如何保证业务不停情况下面，实现在线迁移？ 数据迁移后如果发现业务异常需要回滚，如何处理新产生的数据？ 为了解决以上的问题，我们需要引入一整套解决方案，包含以下部分：\n指导文档 A：SQL Server 转换 MySQL 的数据类型对应表 指导文档 B：MySQL 的使用方式以及注意点 支持表结构变更，从 SQL Server 到 MySQL 的 ETL 工具 支持 SQL Server 到 MySQL 的在线 ETL 工具 一致性校验工具 一个回滚工具 让我们一一来解决这些问题。\nSQL Server 到 MySQL 指导文档 非常幸运的是，MySQL 官方早就准备了一份如何其他数据库迁移到 MySQL 的白皮书。 MySQL :: Guide to Migrating from Microsoft SQL Server to MySQL 里提供了详尽的 SQL Server 到 MySQL 的对应方案。 包含了：\nSQL Server to MySQL - Datatypes 数据类型对应表 SQL Server to MySQL - Predicates 逻辑算子对应表 SQL Server to MySQL – Operators and Date Functions 函数对应表 T-SQL Conversion Suggestions 存储过程转换建议 需要额外处理的数据类型：\nSQL Server MySQL IDENTITY AUTO_INCREMENT NTEXT, NATIONAL TEXT TEXT CHARACTER SET UTF8 SMALLDATETIME DATETIME MONEY DECIMAL(19,4) SMALL MONEY DECIMAL(10,4) UNIQUEIDENTIFIER BINARY(16) SYSNAME CHAR(256) 在实际进行中，还额外遇到了一个用来解决树形结构存储的字段类型 Hierarchyid。这个场景需要额外进行业务调整。\n我们在内部做了针对 MySQL 知识的摸底排查工作， 并进行了若干次的 MySQL 使用技巧培训， 将工程师对 MySQL 的认知拉到一根统一的线。\n关于存储过程使用，我们和业务方也达成了一致：所有 SQL Server 存储过程使用业务代码进行重构，不能在 MySQL 中使用存储过程。 原因是存储过程增加了业务和 DB 的耦合，会让维护成本变得极高。 另外 MySQL 的存储过程功能和性能都较弱，无法大规模使用。\n最后我们提供了一个 MySQL 开发规范文档，借数据库迁移的机会， 将之前相对混乱的表结构设计做了统一了约束（部分有业务绑定的设计， 在考虑成本之后没有做调整）。\nETL 工具 ETL 的全称是 Extract Translate Load（读取、转换、载入）， 数据库迁移最核心过程就是 ETL 过程。 如果将 ETL 过程简化，去掉 Translate 过程， 就退化为一个简单的数据导入导出工具。 我们可以先看一下市面上常见的导入导出工具， 了解他们的原理和特性，方便我们选型。\nMySQL 同构数据库数据迁移工具：\nmysqldump 和 mysqlimport MySQL 官方提供的 SQL 导出导出工具 pt-table-sync Percona 提供的主从同步工具 XtraBackup Percona 提供的备份工具 异构数据库迁移工具：\nDatabase migration and synchronization tools ：国外一家提供数据库迁移解决方案的公司 DataX ：阿里巴巴开发的数据库同步工具 yugong ：阿里巴巴开发的数据库迁移工具 MySQL Workbench ：MySQL 提供的 GUI 管理工具，包含数据库迁移功能 Data Integration - Kettle ：国外的一款 GUI ETL 工具 Ispirer ：提供应用程序、数据库异构迁移方案的公司 DB2DB 数据库转换工具 ：一个国产的商业数据库迁移软件 Navicat Premium ：经典的数据库管理工具，带数据迁移功能 DBImport ：个人维护的迁移工具，非常简陋，需要付费 看上去异构数据库迁移工具和方案很多，但是经过我们调研，其中不少是为老派的传统行业服务的。 比如 Kettle / Ispirerer，他们关注的特性，不能满足互联网公司对性能、迁移耗时的要求。 简单筛选后，以下几个工具进入我们候选列表（为了做特性对比，加入几个同构数据库迁移工具）：\n工具名称 热数据备份保证一致性 batch 操作 支持异构数据库 断点续接 开源 开发语言 GUI mysqldump V 使用 single-transaction X X X V C X pt-table-sync V 使用 transaction 或 lock table 的 FTWRL V X V V Pell X DataX X V V X V Java X yugong X V V V V Java X DB2DB X V V X X .net V MySQL Workbench X ? V X V C++ V 由于异构数据库迁移，真正能够进入我们选型的只有 DataX / yugong / DB2DB / MySQL Workbench。 经过综合考虑，我们最终选用了三种方案， DB2DB 提供小数据量、简单模式的停机模式支持， 足以应付小数据量的停机迁移，开发工程师可以自助完成。 DataX 为大数据量的停机模式提供服务， 使用 JSON 进行配置，通过修改查询 SQL，可以完成一部分结构调整工程。 yugong 的强大可定制性也为在线迁移提供了基础， 我们在官方开源版本的基础之上，增加了以下额外功能：\n支持 SQL Server 作为 Source 和 Target 支持 MySQL 作为 Source 支持 SQL Server 增量更新 支持使用 YAML 作为配置格式 调整 yugong 为 fat jar 模式运行 支持表名、字段名大小写格式变化，驼峰和下划线自由转换 支持表名、字段名细粒度自定义 支持复合主键迁移 支持迁移过程中完成 Range / Time / Mod / Hash 分表 支持新增、删除字段 关于 yugong 的二次开发，我们也积累了一些经验，这个我们下篇文章会来分享。\n一致性校验工具 在 ETL 之后，需要有一个流程来确认数据迁移前后是否一致。 虽然理论上不会有差异，但是如果中间有程序异常， 或者数据库在迁移过程中发生操作，数据就会不一致。\n业界有没有类似的工具呢？ 有，Percona 提供了 pt-table-checksum 这样的工具， 这个工具设计从 master 使用 checksum 来和 slave 进行数据对比。 这个设计场景是为 MySQL 主从同步设计， 显然无法完成从 SQL Server 到 MySQL 的一致性校验。 尽管如此，它的一些技术设计特性也值得参考：\n一次检查一张表 每次检查表，将表数据拆分为多个 trunk 进行检查 使用 REPLACE...SELECT 查询，避免大表查询的长时间带来的不一致性 每个 trunk 的查询预期时间是 0.5s 动态调整 trunk 大小，使用指数级增长控制大小 查询超时时间 1s / 并发量 25 支持故障后断点恢复 在数据库内部维护 src / diff，meta 信息 通过 Master 提供的信息自动连接上 slave 必须 Schema 结构一致 我们选择 yugong 作为 ETL 工具的一大原因也是因为它提供了多种模式。 支持 CHECK / FULL / INC / AUTO 四种模式。 其中 CHECK 模式就是将 yugong 作为数据一致性检查工具使用。 yugong 工作原理是通过 JDBC 根据主键范围变化，将数据取出进行批量对比。\n这个模式会遇到一点点小问题，如果数据库表没有主键，将无法进行顺序对比。 其实不同数据库有自己的逻辑主键，Oracle 有 rowid， SQL Server 有 physloc。这种方案可以解决无主键进行比对的问题。\n如何回滚 我们需要考虑一个场景，在数据库迁移成功之后业务已经运行了几个小时， 但是遇到了一些 Critical 级别的问题，必须回滚到迁移之前状态。 这时候如何保证这段时间内的数据更新到老的数据库里面去？\n最朴素的做法是，在业务层面植入 DAO 层的打点， 将 SQL 操作记录下来到老数据库进行重放。 这种方式虽然直观，但是要侵入业务系统，直接被我们否决了。 其实这种方式是 binlog statement based 模式， 理论上我们可以直接从 MySQL 的 binlog 里面获取数据变更记录。 以 row based 方式重放到 SQL Server。\n这时候又涉及到逆向 ETL 过程， 因为很可能 Translate 过程中，做了表结构重构。 我们的解决方法是，使用 Canal 对 MySQL binlog 进行解析， 然后将解析之后的数据作为数据源， 将其中的变更重放到 SQL Server。\n由于回滚的过程也是 ETL，基于 yugong， 我们继续定制了 SQL Server 的写入功能， 这个模式类似于在线迁移，只不过方向是从 MySQL 到 SQL Server。\n其他实践 我们在迁移之前做了大量压测工作， 并针对每个迁移的 DB 进行线上环境一致的全真演练。 我们构建了和生产环境机器配置一样， 数据量一样的测试环境，并要求每个系统在上线之前都进行若干次演练。 演练之前准备详尽的操作手册和事故处理方案。 演练准出的标准是：能够在单次演练中不出任何意外，时间在估计范围内。 通过演练我们保证了整个操作时间可控，减少操作时候的风险。\n为了让数据库的状态更为直观的展现出来， 我们对 MySQL / SQL Server 添加了细致的 Metrics 监控。 在测试和迁移过程中，可以便利地看到数据库的响应情况。\n为了方便 DBA 快速 Review SQL。 我们提供了一些工具，直接将代码库中的 SQL 拎出来， 可以方便地进行 SQL Review。 再配合其他 SQL Review 工具， 比如 Meituan-Dianping/SQLAdvisor， 可以实现一部分自动化，提高 DBA 效率，避免线上出现明显的 Slow SQL。\n最后 基于这几种方案我们打了一套组合拳。经过将近一年的使用， 进行了 28 个通宵，迁移了 42 个系统， 完成了包括用户、订单、支付、电商、学习、社群、内容和工具的迁移。 迁移的数据总规模接近百亿，所有迁移项目均一次成功。 迁移过程中积累了丰富的实战经验，保障了业务快速向前发展。\n下一篇：从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D\n",
  "wordCount" : "3897",
  "inLanguage": "en",
  "datePublished": "2018-03-12T21:08:56+08:00",
  "dateModified": "2018-03-12T21:08:56+08:00",
  "author":{
    "@type": "Person",
    "name": "alswl"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.alswl.com/2018/03/sql-server-migration-1/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Log4D",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.alswl.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.alswl.com" accesskey="h" title="Log4D (Alt + H)">Log4D</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://en.blog.alswl.com/" title="English Blog">
                    <span>English Blog</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/archives/" title="存档">
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/about/" title="关于我">
                    <span>关于我</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.alswl.com">Home</a>&nbsp;»&nbsp;<a href="https://blog.alswl.com/posts/">Posts</a></div>
    <h1 class="post-title">
      从 SQL Server 到 MySQL（一）：异构数据库迁移
    </h1>
    <div class="post-meta"><span title='2018-03-12 21:08:56 +0800 +0800'>2018-03-12</span>&nbsp;·&nbsp;alswl

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#迁移方案的基本流程">迁移方案的基本流程</a></li>
    <li><a href="#需要解决的问题">需要解决的问题</a></li>
    <li><a href="#sql-server-到-mysql-指导文档">SQL Server 到 MySQL 指导文档</a></li>
    <li><a href="#etl-工具">ETL 工具</a></li>
    <li><a href="#一致性校验工具">一致性校验工具</a></li>
    <li><a href="#如何回滚">如何回滚</a></li>
    <li><a href="#其他实践">其他实践</a></li>
    <li><a href="#最后">最后</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>该系列三篇文章已经全部完成：</p>
<ul>
<li><a href="https://blog.alswl.com/2018/03/sql-server-migration-1/">从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D</a></li>
<li><a href="https://blog.alswl.com/2018/05/sql-server-migration-2/">从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D</a></li>
<li><a href="https://blog.alswl.com/2018/06/sql-server-migration-3/">从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D</a></li>
</ul>
<p>




<img loading="lazy" src="https://d05fae.dijingchao.com/upload_dropbox/201803/migration-bird.png" alt="201803/migration-bird.png"  />

</p>
<h2 id="背景">背景<a hidden class="anchor" aria-hidden="true" href="#背景">#</a></h2>
<p>沪江成立于 2001 年，作为较早期的教育学习网站，
当时技术选型范围并不大：
Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购，
版本号是 3.23。
工程师们选择了当时最合适的微软体系，并在日后的岁月里，
逐步从 ASP 过度到 .net，数据库也跟随 SQL Server 进行版本升级。</p>
<p>十几年过去了，技术社区已经发生了天翻地覆的变化。
沪江的技术栈还基本在 .net 体系上，这给业务持续发展带来了一些限制。
人才招聘、社区生态、架构优化、成本风险方面都面临挑战。
集团经过慎重考虑，发起了大规模的去 Windows 化项目。
这其中包含两个重点子项目：开发语言从 C# 迁移到 Java，
数据库从 SQL Server 迁移到 MySQL。</p>
<p>本系列文章就是向大家介绍，
从 SQL Server 迁移到 MySQL 所面临的问题和我们的解决方案。</p>
<!-- more -->
<h2 id="迁移方案的基本流程">迁移方案的基本流程<a hidden class="anchor" aria-hidden="true" href="#迁移方案的基本流程">#</a></h2>
<p>设计迁移方案需要考量以下几个指标：</p>
<ul>
<li>迁移前后的数据一致性</li>
<li>业务停机时间</li>
<li>迁移项目是否对业务代码有侵入</li>
<li>需要提供额外的功能：表结构重构、字段调整</li>
</ul>
<p>经过仔细调研，在平衡复杂性和业务方需求后，
迁移方案设计为两种：停机数据迁移和在线数据迁移。
如果业务场景允许数小时的停机，那么使用停机迁移方案，
复杂度低，数据损失风险低。
如果业务场景不允许长时间停机，或者迁移数据量过大，
无法在几个小时内迁移完成，那么就需要使用在线迁移方案了。</p>
<p>数据库停机迁移的流程：</p>
<p>




<img loading="lazy" src="https://d05fae.dijingchao.com/upload_dropbox/201803/migration-db-offline-readonly.png" alt="201803/migration-db-offline-readonly.png"  />

</p>
<p>停机迁移逻辑比较简单，使用 ETL（Extract Translate Load）
工具从 Source 写入 Target，然后进行一致性校验，最后确认应用运行 OK，
将 Source 表名改掉进行备份。</p>
<p>在线迁移的流程：</p>
<p>




<img loading="lazy" src="https://d05fae.dijingchao.com/upload_dropbox/201803/migration-db-online.png" alt="201803/migration-db-online.png"  />

</p>
<p>在线迁移的方案稍微复杂一些，流程上有准备全量数据，然后实时同步增量数据，
在数据同步跟上（延迟秒级别）之后，进行短暂停机（Hang 住，确保没有流量），
就可以使用新的应用配置，并使用新的数据库。</p>
<h2 id="需要解决的问题">需要解决的问题<a hidden class="anchor" aria-hidden="true" href="#需要解决的问题">#</a></h2>
<p>从 SQL Server 迁移到 MySQL，核心是完成异构数据库的迁移。</p>
<p>基于两种数据迁移方案，我们需要解决以下问题：</p>
<ul>
<li>两个数据库的数据结构是否可以一一对应？出现不一致如何处理？</li>
<li>MySQL 的使用方式和 SQL Server 使用方式是否一致？有哪些地方需要注意？</li>
<li>如何确保迁移前后的数据一致性？</li>
<li>在迁移中，如何支持数据结构调整？</li>
<li>如何保证业务不停情况下面，实现在线迁移？</li>
<li>数据迁移后如果发现业务异常需要回滚，如何处理新产生的数据？</li>
</ul>
<p>为了解决以上的问题，我们需要引入一整套解决方案，包含以下部分：</p>
<ul>
<li>指导文档 A：SQL Server 转换 MySQL 的数据类型对应表</li>
<li>指导文档 B：MySQL 的使用方式以及注意点</li>
<li>支持表结构变更，从 SQL Server 到 MySQL 的 ETL 工具</li>
<li>支持 SQL Server 到 MySQL 的在线 ETL 工具</li>
<li>一致性校验工具</li>
<li>一个回滚工具</li>
</ul>
<p>让我们一一来解决这些问题。</p>
<h2 id="sql-server-到-mysql-指导文档">SQL Server 到 MySQL 指导文档<a hidden class="anchor" aria-hidden="true" href="#sql-server-到-mysql-指导文档">#</a></h2>
<p>非常幸运的是，MySQL 官方早就准备了一份如何其他数据库迁移到
MySQL 的白皮书。
<a href="https://www.mysql.com/it/why-mysql/white-papers/guide-to-migrating-from-sql-server-to-mysql/">MySQL :: Guide to Migrating from Microsoft SQL Server to MySQL</a>
里提供了详尽的 SQL Server 到 MySQL 的对应方案。
包含了：</p>
<ul>
<li>SQL Server to MySQL - Datatypes 数据类型对应表</li>
<li>SQL Server to MySQL - Predicates 逻辑算子对应表</li>
<li>SQL Server to MySQL – Operators and Date Functions 函数对应表</li>
<li>T-SQL Conversion Suggestions 存储过程转换建议</li>
</ul>
<p>需要额外处理的数据类型：</p>
<table>
<thead>
<tr>
<th>SQL Server</th>
<th>MySQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>IDENTITY</td>
<td>AUTO_INCREMENT</td>
</tr>
<tr>
<td>NTEXT, NATIONAL TEXT</td>
<td>TEXT CHARACTER SET UTF8</td>
</tr>
<tr>
<td>SMALLDATETIME</td>
<td>DATETIME</td>
</tr>
<tr>
<td>MONEY</td>
<td>DECIMAL(19,4)</td>
</tr>
<tr>
<td>SMALL MONEY</td>
<td>DECIMAL(10,4)</td>
</tr>
<tr>
<td>UNIQUEIDENTIFIER</td>
<td>BINARY(16)</td>
</tr>
<tr>
<td>SYSNAME</td>
<td>CHAR(256)</td>
</tr>
</tbody>
</table>
<p>在实际进行中，还额外遇到了一个用来解决树形结构存储的字段类型
Hierarchyid。这个场景需要额外进行业务调整。</p>
<p>我们在内部做了针对 MySQL 知识的摸底排查工作，
并进行了若干次的 MySQL 使用技巧培训，
将工程师对 MySQL 的认知拉到一根统一的线。</p>
<p>关于存储过程使用，我们和业务方也达成了一致：所有 SQL Server
存储过程使用业务代码进行重构，不能在 MySQL 中使用存储过程。
原因是存储过程增加了业务和 DB 的耦合，会让维护成本变得极高。
另外 MySQL 的存储过程功能和性能都较弱，无法大规模使用。</p>
<p>最后我们提供了一个 MySQL 开发规范文档，借数据库迁移的机会，
将之前相对混乱的表结构设计做了统一了约束（部分有业务绑定的设计，
在考虑成本之后没有做调整）。</p>
<h2 id="etl-工具">ETL 工具<a hidden class="anchor" aria-hidden="true" href="#etl-工具">#</a></h2>
<p>ETL 的全称是 Extract Translate Load（读取、转换、载入），
数据库迁移最核心过程就是 ETL 过程。
如果将 ETL 过程简化，去掉 Translate 过程，
就退化为一个简单的数据导入导出工具。
我们可以先看一下市面上常见的导入导出工具，
了解他们的原理和特性，方便我们选型。</p>
<p>MySQL 同构数据库数据迁移工具：</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html">mysqldump</a>
和 <a href="https://dev.mysql.com/doc/refman/5.7/en/mysqlimport.html">mysqlimport</a>
MySQL 官方提供的 SQL 导出导出工具</li>
<li><a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-table-sync.html">pt-table-sync</a>
Percona 提供的主从同步工具</li>
<li><a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">XtraBackup</a>
Percona 提供的备份工具</li>
</ul>
<p>异构数据库迁移工具：</p>
<ul>
<li><a href="https://www.convert-in.com/">Database migration and synchronization tools</a>
：国外一家提供数据库迁移解决方案的公司</li>
<li><a href="https://github.com/alibaba/DataX">DataX</a>
：阿里巴巴开发的数据库同步工具</li>
<li><a href="https://github.com/alibaba/yugong">yugong</a>
：阿里巴巴开发的数据库迁移工具</li>
<li><a href="https://www.mysql.com/cn/products/workbench/">MySQL Workbench</a>
：MySQL 提供的 GUI 管理工具，包含数据库迁移功能</li>
<li><a href="https://community.hds.com/docs/DOC-1009855">Data Integration - Kettle</a>
：国外的一款 GUI ETL 工具</li>
<li><a href="https://www.ispirer.cn/products/sql-server-to-mysql-migration">Ispirer</a>
：提供应用程序、数据库异构迁移方案的公司</li>
<li><a href="http://www.szmesoft.com/DB2DB">DB2DB 数据库转换工具</a>
：一个国产的商业数据库迁移软件</li>
<li><a href="https://www.navicat.com/en/products/navicat-premium">Navicat Premium</a>
：经典的数据库管理工具，带数据迁移功能</li>
<li><a href="http://www.cnblogs.com/cyq1162/p/5637978.html">DBImport</a>
：个人维护的迁移工具，非常简陋，需要付费</li>
</ul>
<p>看上去异构数据库迁移工具和方案很多，但是经过我们调研，其中不少是为老派的传统行业服务的。
比如 Kettle / Ispirerer，他们关注的特性，不能满足互联网公司对性能、迁移耗时的要求。
简单筛选后，以下几个工具进入我们候选列表（为了做特性对比，加入几个同构数据库迁移工具）：</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>热数据备份保证一致性</th>
<th>batch 操作</th>
<th>支持异构数据库</th>
<th>断点续接</th>
<th>开源</th>
<th>开发语言</th>
<th>GUI</th>
</tr>
</thead>
<tbody>
<tr>
<td>mysqldump</td>
<td>V 使用 <code>single-transaction</code></td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>V</td>
<td>C</td>
<td>X</td>
</tr>
<tr>
<td>pt-table-sync</td>
<td>V 使用 transaction 或 <code>lock table</code> 的 FTWRL</td>
<td>V</td>
<td>X</td>
<td>V</td>
<td>V</td>
<td>Pell</td>
<td>X</td>
</tr>
<tr>
<td>DataX</td>
<td>X</td>
<td>V</td>
<td>V</td>
<td>X</td>
<td>V</td>
<td>Java</td>
<td>X</td>
</tr>
<tr>
<td>yugong</td>
<td>X</td>
<td>V</td>
<td>V</td>
<td>V</td>
<td>V</td>
<td>Java</td>
<td>X</td>
</tr>
<tr>
<td>DB2DB</td>
<td>X</td>
<td>V</td>
<td>V</td>
<td>X</td>
<td>X</td>
<td>.net</td>
<td>V</td>
</tr>
<tr>
<td>MySQL Workbench</td>
<td>X</td>
<td>?</td>
<td>V</td>
<td>X</td>
<td>V</td>
<td>C++</td>
<td>V</td>
</tr>
</tbody>
</table>
<p>由于异构数据库迁移，真正能够进入我们选型的只有
DataX / yugong / DB2DB / MySQL Workbench。
经过综合考虑，我们最终选用了三种方案，
DB2DB 提供小数据量、简单模式的停机模式支持，
足以应付小数据量的停机迁移，开发工程师可以自助完成。
DataX 为大数据量的停机模式提供服务，
使用 JSON 进行配置，通过修改查询 SQL，可以完成一部分结构调整工程。
yugong 的强大可定制性也为在线迁移提供了基础，
我们在官方开源版本的基础之上，增加了以下额外功能：</p>
<ul>
<li>支持 SQL Server 作为 Source 和 Target</li>
<li>支持 MySQL 作为 Source</li>
<li>支持 SQL Server 增量更新</li>
<li>支持使用 YAML 作为配置格式</li>
<li>调整 yugong 为 fat jar 模式运行</li>
<li>支持表名、字段名大小写格式变化，驼峰和下划线自由转换</li>
<li>支持表名、字段名细粒度自定义</li>
<li>支持复合主键迁移</li>
<li>支持迁移过程中完成 Range / Time / Mod / Hash 分表</li>
<li>支持新增、删除字段</li>
</ul>
<p>关于 yugong 的二次开发，我们也积累了一些经验，这个我们下篇文章会来分享。</p>
<h2 id="一致性校验工具">一致性校验工具<a hidden class="anchor" aria-hidden="true" href="#一致性校验工具">#</a></h2>
<p>在 ETL 之后，需要有一个流程来确认数据迁移前后是否一致。
虽然理论上不会有差异，但是如果中间有程序异常，
或者数据库在迁移过程中发生操作，数据就会不一致。</p>
<p>业界有没有类似的工具呢？
有，Percona 提供了 pt-table-checksum 这样的工具，
这个工具设计从 master 使用 <code>checksum</code> 来和 slave 进行数据对比。
这个设计场景是为 MySQL 主从同步设计，
显然无法完成从 SQL Server 到 MySQL 的一致性校验。
尽管如此，它的一些技术设计特性也值得参考：</p>
<ul>
<li>一次检查一张表</li>
<li>每次检查表，将表数据拆分为多个 trunk 进行检查</li>
<li>使用 <code>REPLACE...SELECT</code> 查询，避免大表查询的长时间带来的不一致性</li>
<li>每个 trunk 的查询预期时间是 0.5s</li>
<li>动态调整 trunk 大小，使用指数级增长控制大小</li>
<li>查询超时时间 1s / 并发量 25</li>
<li>支持故障后断点恢复</li>
<li>在数据库内部维护 src / diff，meta 信息</li>
<li>通过 Master 提供的信息自动连接上 slave</li>
<li>必须 Schema 结构一致</li>
</ul>
<p>我们选择 yugong 作为 ETL 工具的一大原因也是因为它提供了多种模式。
支持 CHECK / FULL / INC / AUTO 四种模式。
其中 CHECK 模式就是将 yugong 作为数据一致性检查工具使用。
yugong 工作原理是通过 JDBC 根据主键范围变化，将数据取出进行批量对比。</p>
<p>这个模式会遇到一点点小问题，如果数据库表没有主键，将无法进行顺序对比。
其实不同数据库有自己的逻辑主键，Oracle 有 <code>rowid</code>，
SQL Server 有 <code>physloc</code>。这种方案可以解决无主键进行比对的问题。</p>
<h2 id="如何回滚">如何回滚<a hidden class="anchor" aria-hidden="true" href="#如何回滚">#</a></h2>
<p>我们需要考虑一个场景，在数据库迁移成功之后业务已经运行了几个小时，
但是遇到了一些 Critical 级别的问题，必须回滚到迁移之前状态。
这时候如何保证这段时间内的数据更新到老的数据库里面去？</p>
<p>最朴素的做法是，在业务层面植入 DAO 层的打点，
将 SQL 操作记录下来到老数据库进行重放。
这种方式虽然直观，但是要侵入业务系统，直接被我们否决了。
其实这种方式是 binlog statement based 模式，
理论上我们可以直接从 MySQL 的 binlog 里面获取数据变更记录。
以 row based 方式重放到 SQL Server。</p>
<p>这时候又涉及到逆向 ETL 过程，
因为很可能 Translate 过程中，做了表结构重构。
我们的解决方法是，使用 Canal 对 MySQL binlog 进行解析，
然后将解析之后的数据作为数据源，
将其中的变更重放到 SQL Server。</p>
<p>由于回滚的过程也是 ETL，基于 yugong，
我们继续定制了 SQL Server 的写入功能，
这个模式类似于在线迁移，只不过方向是从 MySQL 到 SQL Server。</p>
<h2 id="其他实践">其他实践<a hidden class="anchor" aria-hidden="true" href="#其他实践">#</a></h2>
<p>我们在迁移之前做了大量压测工作，
并针对每个迁移的 DB 进行线上环境一致的全真演练。
我们构建了和生产环境机器配置一样，
数据量一样的测试环境，并要求每个系统在上线之前都进行若干次演练。
演练之前准备详尽的操作手册和事故处理方案。
演练准出的标准是：能够在单次演练中不出任何意外，时间在估计范围内。
通过演练我们保证了整个操作时间可控，减少操作时候的风险。</p>
<p>为了让数据库的状态更为直观的展现出来，
我们对 MySQL / SQL Server 添加了细致的 Metrics 监控。
在测试和迁移过程中，可以便利地看到数据库的响应情况。</p>
<p>




<img loading="lazy" src="https://d05fae.dijingchao.com/upload_dropbox/201803/sql-server-metrics.png" alt="201803/sql-server-metrics.png"  />

</p>
<p>




<img loading="lazy" src="https://d05fae.dijingchao.com/upload_dropbox/201803/mysql-metrics.png" alt="201803/mysql-metrics.png"  />

</p>
<p>为了方便 DBA 快速 Review SQL。
我们提供了一些工具，直接将代码库中的 SQL 拎出来，
可以方便地进行 SQL Review。
再配合其他 SQL Review 工具，
比如 <a href="https://github.com/Meituan-Dianping/SQLAdvisor">Meituan-Dianping/SQLAdvisor</a>，
可以实现一部分自动化，提高 DBA 效率，避免线上出现明显的 Slow SQL。</p>
<h2 id="最后">最后<a hidden class="anchor" aria-hidden="true" href="#最后">#</a></h2>
<p>基于这几种方案我们打了一套组合拳。经过将近一年的使用，
进行了 28 个通宵，迁移了 42 个系统，
完成了包括用户、订单、支付、电商、学习、社群、内容和工具的迁移。
迁移的数据总规模接近百亿，所有迁移项目均一次成功。
迁移过程中积累了丰富的实战经验，保障了业务快速向前发展。</p>
<p>下一篇：<a href="https://blog.alswl.com/2018/05/sql-server-migration-2/">从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D</a></p>

<hr />
<p>原文链接: <a href="https://blog.alswl.com/2018/03/sql-server-migration-1/">从 SQL Server 到 MySQL（一）：异构数据库迁移 | Log4D</a></p>
<p>3a1ff193cee606bd1e2ea554a16353ee</p>
<p>欢迎关注我的微信公众号：<a
href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect">窥豹</a></p>
<figure>
<img
src="https://4ocf5n.dijingchao.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"
alt="窥豹" />
<figcaption aria-hidden="true">窥豹</figcaption>
</figure>

    
  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.alswl.com/tags/sqlserver/">sqlserver</a></li>
      <li><a href="https://blog.alswl.com/tags/mysql/">mysql</a></li>
      <li><a href="https://blog.alswl.com/tags/db-migration/">db-migration</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.alswl.com/2018/04/death-sea-effect/">
    <span class="title">« Prev</span>
    <br>
    <span>如何逃离死海效应</span>
  </a>
  <a class="next" href="https://blog.alswl.com/2018/01/2017-2018/">
    <span class="title">Next »</span>
    <br>
    <span>从 2017 到 2018</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "log4d" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://blog.alswl.com">Log4D</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
