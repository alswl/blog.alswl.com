<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="block-all-mixed-content">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />



<link rel="canonical" href="https://blog.alswl.com/2018/05/sql-server-migration-2/">

        <meta name="author" content="alswl" />
        <meta name="keywords" content="SQLServer,MySQL,DB-Migration" />
        <meta name="description" content="该系列三篇文章已经全部完成： 从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三 …" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cdn.staticfile.org/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.alswl.com/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.alswl.com/theme/css/style.css" type="text/css"/>

    <link href="https://blog.alswl.com/atom.xml" type="application/atom+xml" rel="alternate" title="Log4D Atom Feed" />
    <link href="https://blog.alswl.com/rss.xml" type="application/rss+xml" rel="alternate" title="Log4D RSS Feed" />

</head>
<body>

<div class="navbar navbar-default" role="navigation">
    <div class="container  col-lg-8 col-lg-offset-2">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.alswl.com/" class="navbar-brand">
Log4D            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/tags/">Tags</a></li>
                    <li><a href="/links/">Links</a></li>
                    <li><a href="/about/">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://blog.alswl.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2">

    <section id="content">
        <article class="article-detail">
            <header class="page-header">
                <h1 class="title">
                    <a href="https://blog.alswl.com/2018/05/sql-server-migration-2/"
                       rel="bookmark"
                       title="Permalink to 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机">
                        从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-05-21T11:24:36+08:00"> 2018-05-21</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="https://blog.alswl.com/tag/sqlserver/">SQLServer</a>
        /
	<a href="https://blog.alswl.com/tag/mysql/">MySQL</a>
        /
	<a href="https://blog.alswl.com/tag/db-migration/">DB-Migration</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>该系列三篇文章已经全部完成：</p>
<ul>
<li><a href="https://blog.alswl.com/2018/03/sql-server-migration-1/">从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D</a></li>
<li><a href="https://blog.alswl.com/2018/05/sql-server-migration-2/">从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D</a></li>
<li><a href="https://blog.alswl.com/2018/06/sql-server-migration-3/">从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D</a></li>
</ul>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/flying-tanker.png" alt="flying-tanker" /><figcaption>flying-tanker</figcaption>
</figure>
<p><smaill>（image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）</small></p>
<p>在上篇文章 <a href="https://blog.alswl.com/2018/03/sql-server-migration-1/">从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D</a> 中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。 全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的： 迁移过程中需要停机，停机的时长和数据量相关。 对于核心业务来说，停机就意味着损失。 比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。 而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。</p>
<p>能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？ 作为有追求的技术人，我们一定要想办法解决上面的问题。</p>
<!-- more -->
<h2 id="在线迁移的原理和流程">在线迁移的原理和流程</h2>
<p>针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的 <a href="https://github.com/alibaba/yugong">yugong</a> 项目。 在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle 的在线迁移。</p>
<p>下图是 yugong 针对 Oracle 到 MySQL 的增量迁移流程：</p>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/yugong-oracle.png" alt="yugong-oracle.png" /><figcaption>yugong-oracle.png</figcaption>
</figure>
<p>这其中有四个步骤：</p>
<ol type="1">
<li>增量数据收集 (创建 Oracle 表的增量物化视图)</li>
<li>进行全量复制</li>
<li>进行增量复制 (可并行进行数据校验)</li>
<li>原库停写，切到新库</li>
</ol>
<p>Oracle 物化视图（Materialized View）是 Oracle 提供的一个机制。 一个物化视图就是主库在某一个时间点上的复制，可以理解为是这个时间点上的 Snapshot。 当主库的数据持续更新时，物化视图的更新可以通过独立的批量更新完成，称之为 <code>refreshes</code>。 一批 <code>refreshes</code> 之间的变化，就对应到数据库的内容变化情况。 物化视图经常用来将主库的数据复制到从库，也常常在数据仓库用来缓存复杂查询。</p>
<p>物化视图有多种配置方式，这里比较关心刷新方式和刷新时间。 刷新方式有三种：</p>
<ul>
<li>Complete Refresh：删除所有数据记录重新生成物化视图</li>
<li>Fast Refresh：增量刷新</li>
<li>Force Refresh：根据条件判断使用 Complete Refresh 和 Fast Refres</li>
</ul>
<p>刷新机制有两种模式： Refresh-on-commit 和 Refresh-On-Demand。</p>
<p>Oracle 基于物化视图，就可以完成增量数据的获取，从而满足阿里的数据在线迁移。 将这个技术问题泛化一下，想做到在线增量迁移需要有哪些特性？ 我们得到如下结论（针对源数据库）：</p>
<ul>
<li>增量变化：支持增量获得增量数据库变化</li>
<li>延迟：获取变化数据这个动作耗时需要尽可能低</li>
<li>幂等一致性：变化数据的消费应当做到幂等，即不管目标数据库已有数据什么状态，都可以无差别消费</li>
</ul>
<p>回到我们面临的问题上来，SQL Server 是否有这个机制满足这三个特性呢？ 答案是肯定的，SQL Server 官方提供了 CDC 功能。</p>
<h2 id="cdc-的工作原理">CDC 的工作原理</h2>
<p>什么是 CDC？ CDC 全称 Change Data Capture，设计目的就是用来解决增量数据的。 它是 SQL Server 2008 新增的特性， 在这之前只能使用 SQl Server 2005 中的 <code>after insert</code> / <code>after delete</code> / <code>after update</code> Trigger 功能来获得数据变化。</p>
<p>CDC 的工作原理如下：</p>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-data-flow.png" alt="cdc-data-flow.png" /><figcaption>cdc-data-flow.png</figcaption>
</figure>
<p>当数据库表发生变化时候，Capture process 会从 transaction log 里面获取数据变化， 然后将这些数据记录到 Change Table 里面。 有了这些数据，用户可以通过特定的 CDC 查询函数将这些变化数据查出来。</p>
<h2 id="cdc-的数据结构和基本使用">CDC 的数据结构和基本使用</h2>
<p>CDC 的核心数据就是那些 Change Table 了，这里我们给大家看一下 Change Table 长什么样，可以有个直观的认识。</p>
<p>通过以下的函数打开一张表（fruits）的 CDC 功能。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb1-1" title="1"><span class="co">-- enable cdc for db</span></a>
<a class="sourceLine" id="cb1-2" title="2">sys.sp_cdc_enable_db;</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">-- enable by table</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">EXEC</span> sys.sp_cdc_enable_table @source_schema <span class="op">=</span> N<span class="st">&#39;dbo&#39;</span>, @source_name <span class="op">=</span> N<span class="st">&#39;fruits&#39;</span>, @role_name <span class="op">=</span> <span class="kw">NULL</span>;</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">-- list cdc enabled table</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">SELECT</span> name, is_cdc_enabled <span class="kw">from</span> sys.databases <span class="kw">where</span> is_cdc_enabled <span class="op">=</span> <span class="dv">1</span>;</a></code></pre></div>
<p>至此 CDC 功能已经开启，如果需要查看哪些表开启了 CDC 功能，可以使用一下 SQL：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb2-1" title="1"><span class="co">-- list cdc enabled table</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">SELECT</span> name, is_cdc_enabled <span class="kw">from</span> sys.databases <span class="kw">where</span> is_cdc_enabled <span class="op">=</span> <span class="dv">1</span>;</a></code></pre></div>
<p>开启 CDC 会导致产生一张 Change Table 表 <code>cdc.dbo_fruits_CT</code>，这张表的表结构如何呢？</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb3-1" title="1">.<span class="kw">schema</span> cdc.dbo_fruits_CT</a>
<a class="sourceLine" id="cb3-2" title="2">name            <span class="kw">default</span>  nullable  <span class="kw">type</span>          <span class="fu">length</span>  <span class="kw">indexed</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">--------------  -------  --------  ------------  ------  -------</span></a>
<a class="sourceLine" id="cb3-4" title="4">__$end_lsn      <span class="kw">null</span>     YES       binary        <span class="dv">10</span>      <span class="kw">NO</span></a>
<a class="sourceLine" id="cb3-5" title="5">__$operation    <span class="kw">null</span>     <span class="kw">NO</span>        <span class="dt">int</span>           <span class="dv">4</span>       <span class="kw">NO</span></a>
<a class="sourceLine" id="cb3-6" title="6">__$seqval       <span class="kw">null</span>     <span class="kw">NO</span>        binary        <span class="dv">10</span>      <span class="kw">NO</span></a>
<a class="sourceLine" id="cb3-7" title="7">__$start_lsn    <span class="kw">null</span>     <span class="kw">NO</span>        binary        <span class="dv">10</span>      YES</a>
<a class="sourceLine" id="cb3-8" title="8">__$update_mask  <span class="kw">null</span>     YES       varbinary     <span class="dv">128</span>     <span class="kw">NO</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="kw">id</span>              <span class="kw">null</span>     YES       <span class="dt">int</span>           <span class="dv">4</span>       <span class="kw">NO</span></a>
<a class="sourceLine" id="cb3-10" title="10">name            <span class="kw">null</span>     YES       <span class="dt">varchar</span>(<span class="dv">255</span>)  <span class="dv">255</span>     <span class="kw">NO</span></a></code></pre></div>
<p>这张表中以 <code>__</code> 开头的字段是 CDC 所记录的元数据，<code>id</code> 和 <code>name</code> 是 fruits 表的原始字段。 这意味着 CDC 的表结构和原始表结构是一一对应的。</p>
<p>接下来我们做一些业务操作，让数据库的数据发生一些变化，然后查看 CDC 的 Change Table：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb4-1" title="1"><span class="co">-- 1 step</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">DECLARE</span> @begin_time datetime, @end_time datetime, @begin_lsn binary(<span class="dv">10</span>), @end_lsn binary(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">-- 2 step</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">SET</span> @begin_time <span class="op">=</span> <span class="st">&#39;2017-09-11 14:03:00.000&#39;</span>;</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">SET</span> @end_time   <span class="op">=</span> <span class="st">&#39;2017-09-11 14:10:00.000&#39;</span>;</a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">-- 3 step</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw">SELECT</span> @begin_lsn <span class="op">=</span> sys.fn_cdc_map_time_to_lsn(<span class="st">&#39;smallest greater than&#39;</span>, @begin_time);</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">SELECT</span> @end_lsn <span class="op">=</span> sys.fn_cdc_map_time_to_lsn(<span class="st">&#39;largest less than or equal&#39;</span>, @end_time);</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">-- 4 step</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> cdc.fn_cdc_get_all_changes_dbo_fruits(@begin_lsn, @end_lsn, <span class="st">&#39;all&#39;</span>);</a></code></pre></div>
<p>这里的操作含义是：</p>
<ol type="1">
<li>定义存储过程中需要使用的 4 个变量</li>
<li>begin_time / end_time 是 Human Readable 的字符串格式时间</li>
<li>begin_lsn / end_lsn 是通过 CDC 函数转化过的 Log Sequence Number，代表数据库变更的唯一操作 ID</li>
<li>根据 begin_lsn / end_lsn 查询到 CDC 变化数据</li>
</ol>
<p>查询出来的数据如下所示：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb5-1" title="1">__$start_lsn          __$end_lsn  __$seqval             __$operation  __$update_mask  <span class="kw">id</span>  name</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">--------------------  ----------  --------------------  ------------  --------------  --  ------</span></a>
<a class="sourceLine" id="cb5-3" title="3">0000dede0000019f001a  <span class="kw">null</span>        0000dede0000019f0018  <span class="dv">2</span>             <span class="dv">03</span>              <span class="dv">1</span>   apple</a>
<a class="sourceLine" id="cb5-4" title="4">0000dede000001ad0004  <span class="kw">null</span>        0000dede000001ad0003  <span class="dv">2</span>             <span class="dv">03</span>              <span class="dv">2</span>   apple2</a>
<a class="sourceLine" id="cb5-5" title="5">0000dede000001ba0003  <span class="kw">null</span>        0000dede000001ba0002  <span class="dv">3</span>             <span class="dv">02</span>              <span class="dv">2</span>   apple2</a>
<a class="sourceLine" id="cb5-6" title="6">0000dede000001ba0003  <span class="kw">null</span>        0000dede000001ba0002  <span class="dv">4</span>             <span class="dv">02</span>              <span class="dv">2</span>   apple3</a>
<a class="sourceLine" id="cb5-7" title="7">0000dede000001c10003  <span class="kw">null</span>        0000dede000001c10002  <span class="dv">2</span>             <span class="dv">03</span>              <span class="dv">3</span>   apple4</a>
<a class="sourceLine" id="cb5-8" title="8">0000dede000001cc0005  <span class="kw">null</span>        0000dede000001cc0002  <span class="dv">1</span>             <span class="dv">03</span>              <span class="dv">3</span>   apple4</a></code></pre></div>
<p>可以看到 Change Table 已经如实的记录了我们操作内容，注意 <code>__$operation</code> 代表了数据库操作：</p>
<ul>
<li>1 =&gt; 删除</li>
<li>2 =&gt; 插入</li>
<li>3 =&gt; 更新前数据</li>
<li>4 =&gt; 更新后数据</li>
</ul>
<p>根据查出来的数据，我们可以重现这段时间数据库的操作：</p>
<ul>
<li>新增了 <code>id</code> 为 1 / 2 的两条数据</li>
<li>更新了 <code>id</code> 为 2 的数据</li>
<li>插入了 <code>id</code> 为 3 的数据</li>
<li>删除了 <code>id</code> 为 3 的数据</li>
</ul>
<h2 id="cdc-调优">CDC 调优</h2>
<p>有了 CDC 这个利器，终于意味着我们的方向是没有问题的，我们终于稍稍吁了一口气。 但除了了解原理和使用方式，我们还需要深入了解 CDC 的工作机制，对其进行压测、调优， 了解其极限和边界，否则一旦线上出现不可控的情况，就会对业务带来巨大损失。</p>
<p>我们先看看 CDC 的工作流程，就可以知道有哪些核心参数可以调整：</p>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-influence.png" alt="Influence of capture job parameters" /><figcaption>Influence of capture job parameters</figcaption>
</figure>
<p>上图是 CDC Job 的工作流程：</p>
<ul>
<li>蓝色区域是一次 Log 扫描执行的最大扫描次数：maxscans number（<code>maxscans</code>）</li>
<li>蓝色区域同时被最大扫描 transcation 数量控制：<code>maxtrans</code></li>
<li>浅蓝色区域是扫描间隔时间，单位是秒：<code>pollinginterval</code></li>
</ul>
<p>这三个参数平衡着 CDC 的服务器资源消耗、吞吐量和延迟， 根据具体场景，比如大字段，宽表，BLOB 表，可以调整从而达到满足业务需要。 他们的默认值如下：</p>
<ul>
<li><code>maxscan</code> 默认值 10</li>
<li><code>maxtrans</code> 默认值 500</li>
<li><code>pollinginterval</code> 默认值 5 秒</li>
</ul>
<h2 id="cdc-压测">CDC 压测</h2>
<p>掌握了能够调整的核心参数，我们即将对 CDC 进行了多种形式的测试。 在压测之前，我们还需要确定关键的健康指标，这些指标有：</p>
<ul>
<li>内存：buffer-cache-hit / page-life-expectancy / page-split 等</li>
<li>吞吐：batch-requets / sql-compilations / sql-re-compilations / transactions count</li>
<li>资源消耗：user-connections / processes-blocked / lock-waits / checkpoint-pages</li>
<li>操作系统层面：CPU 利用率、磁盘 IO</li>
</ul>
<p>出于篇幅考虑，我们无法将所有测试结果贴出来， 这里放一个在并发 30 下面插入一百万数据（随机数据）进行展示：</p>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-metrics.png" alt="cdc-metrics.png" /><figcaption>cdc-metrics.png</figcaption>
</figure>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-system-load.png" alt="cdc-system-load.png" /><figcaption>cdc-system-load.png</figcaption>
</figure>
<p>测试结论是，在默认的 CDC 参数下面：</p>
<p>CDC 的开启/关闭过程中会导致若干个 Process Block， 大流量请求下面（15k TPS）过程会导致约 20 个左右 Process Block。 这个过程中对服务器的 IO / CPU 无明显波动， 开启/关闭瞬间会带来 mssql.sql-statistics.sql-compilations 剧烈波动。 CDC 开启后，在大流量请求下面对 QPS / Page IO 无明显波动， 对服务器的 IO / CPU 也无明显波动， CDC 开启后可以在 16k TPS 下正常工作。</p>
<p>如果对性能不达标，官方有一些简单的优化指南：</p>
<ul>
<li>调整 maxscan maxtrans pollinginterval</li>
<li>减少在插入后立刻插入</li>
<li>避免大批量写操作</li>
<li>限制需要记录的字段</li>
<li>尽可能关闭 net changes</li>
<li>没任务压力时跑 cleanup</li>
<li>监控 log file 大小和 IO 压力，确保不会写爆磁盘</li>
<li>要设置 filegroup_name</li>
<li>开启 sp_cdc_enable_table 之前设置 filegroup</li>
</ul>
<h2 id="yugong-的在线迁移机制">yugong 的在线迁移机制</h2>
<p>OK，截目前位置，我们已经具备了 CDC 这个工具，但是这仅仅提供了一种可能性， 我们还需要一个工具将 CDC 的数据消费出来，并喂到 MySQL 里面去。</p>
<p>好在有 yugong。 Yugong 官方提供了 Oracle 到 MySQL 的封装，并且抽象了 Source / Target / SQL Tempalte 等接口， 我们只要实现相关接口，就可以完成从 SQL Server 消费数据到 MySQL 了。</p>
<p>这里我们不展开，我还会花专门的一篇文章讲如何在 yugong 上面进行开发。 可以提前剧透一下，我们已经将支持 SQL Server 的 yugong 版本开源了。</p>
<h2 id="如何回滚">如何回滚</h2>
<p>数据库迁移这样的项目，我们不仅仅要保证单向从 SQL Server 到 MySQL 的写入， 同时要从 MySQL 写入 SQL Server。</p>
<p>这个流程同样考虑增量写入的要素：增量消费，延迟，幂等一致性。</p>
<p>MySQL 的 binlog 可以满足这三个要素，需要注意的是，MySQL binlog 有三种模式， Statement based，Row based 和 Mixed。只有 Row based 才能满足幂等一致性的要求。</p>
<p>确认理论上可行之后，我们一样需要一个工具将 binlog 读取出来，并且将其转化为 SQL Server 可以消费的数据格式，然后写入 SQL Server。</p>
<p>我们目光转到 alibaba 的另外一个项目 Canal。 Canal 是阿里中间件团队提供的 binlog 增量订阅 &amp; 消费组件。 之所以叫组件，是由于 Canal 提供了 Canal-Server 应用和 Canal Client Library， Canal 会模拟成一个 MySQL 实例，作为 Slave 连接到 Master 上面， 然后实时将 binlog 读取出来。 至于 binlog 读出之后想怎么使用，权看用户如何使用。</p>
<p>我们基于 Canal 设计了一个简单的数据流，在 yugong 中增加了这么几个功能：</p>
<ul>
<li>SQL Server 的写入功能</li>
<li>消费 Canal 数据源的功能</li>
</ul>
<p>Canal Server 中的 binlog 只能做一次性消费， 内部实现是一个 Queue， 为了满足我们可以重复消费数据的能力，我们还额外设计了一个环节，将 Canal 的数据放到 Queue 中，在未来任意时间可以重复消费数据。 我们选择了 Redis 作为这个 Queue，数据流如下。</p>
<figure>
<img src="https://4ocf5n.dijingchao.com/upload_dropbox/201805/canal.png" alt="canal.png" /><figcaption>canal.png</figcaption>
</figure>
<h2 id="最佳实践">最佳实践</h2>
<p>数据库的迁移在去 Windows 中，是最不容得出错的环节。 应用是无状态的，出现问题可以通过回切较快地回滚。 但数据库的迁移就需要考虑周到，做好资源准备，发布流程， 故障预案处理。</p>
<p>考虑到多个事业部都需要经历这个一个过程，我们项目组将每一个步骤都固化下来， 形成了一个最佳实践。我们的迁移步骤如下，供大家参考：</p>
<table>
<thead>
<tr class="header">
<th>大阶段</th>
<th>阶段</th>
<th>事项</th>
<th>是否完成</th>
<th>负责人</th>
<th>耗时</th>
<th>开始时间</th>
<th>完成时间</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>白天</td>
<td>存量数据阶段</td>
<td>创建 MySQL 数据库，准备相关账号资源</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>开启 CDC</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>从 Slave SQLServer dump 一份 snapshot 到 Backup SQL Server</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>Backup SQL Server 消费数据， ETL 到 MySQL</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td>增量数据阶段</td>
<td>确认 ETL 数据已经消费完成，检查数据总条数</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>从 Slave SQLServer 开始消费 CDC 数据，持续写入 MySQL</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>使用 yugong 检查一天内数据的一致性</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>检查不一致的数据，10 分钟之后人工进行检查，确认是 CDC 延迟带来的问题</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>检查数据总量条目</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>使用 yugong 对抽样表进行全量检查</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td>凌晨</td>
<td>应用发布阶段</td>
<td>停止 SQL Server 的应用</td>
<td> </td>
<td>技术经理</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>检查没有连接进入 SQL Server</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>使用 yugong 检查一天内数据的一致性</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>检查数据总量条目</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>启用基于 MySQL 的应用</td>
<td> </td>
<td>运维</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td>测试阶段</td>
<td>测试应用是否正常，回归所有功能</td>
<td> </td>
<td>QA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>（临时新增）测试 ReadOnly DB 的应用访问情况</td>
<td> </td>
<td>QA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td>完成阶段</td>
<td>接入流量</td>
<td> </td>
<td>运维</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td>（可选）回滚阶段</td>
<td>发现问题，直接将应用切回 SQL Server</td>
<td> </td>
<td>运维</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="even">
<td> </td>
<td> </td>
<td>事后进行数据审计，进行新增数据补偿</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr class="odd">
<td> </td>
<td> </td>
<td>（可选）回滚过程中，使用 Canal 读取 binlog，并使用 Canal Client 重放到 SQL Server</td>
<td> </td>
<td>DBA</td>
<td> </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
</tbody>
</table>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://docs.oracle.com/cd/B10500_01/server.920/a96567/repmview.htm">Materialized View Concepts and Architecture</a></li>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008/dd266396(v=sql.100)">Tuning the Performance of Change Data Capture in SQL Server 2008 | Microsoft Docs</a></li>
<li><a href="https://github.com/alibaba/yugong">alibaba/yugong: 阿里巴巴去Oracle数据迁移同步工具(全量+增量,目标支持MySQL/DRDS)</a></li>
<li><a href="https://github.com/alibaba/canal">alibaba/canal: 阿里巴巴mysql数据库binlog的增量订阅&amp;消费组件 。阿里云DRDS( https://www.aliyun.com/product/drds )、阿里巴巴TDDL 二级索引、小表复制powerd by canal.</a></li>
</ul>

            </div>
            <!-- /.entry-content -->
              
<hr>
<div class="panel">
<div class="panel-body">
   <small>原文链接: <a href="https://blog.alswl.com/2018/05/sql-server-migration-2/">https://blog.alswl.com/2018/05/sql-server-migration-2/</a></small><br>
   <small>3a1ff193cee606bd1e2ea554a16353ee</small><br>
   <small>欢迎关注我的微信公众号：<a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&wechat_redirect">窥豹</a></small><br>
   <small><img src="https://4ocf5n.dijingchao.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/></small>
   <small><img src="https://4ocf5n.dijingchao.com/upload_dropbox/meta/wechat-pay-s-crop.png"/></small>
</div>
</div>

    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

                    var disqus_identifier = 'sql-server-migration-2';
                var disqus_url = 'https://blog.alswl.com/2018/05/sql-server-migration-2/';

            var disqus_config = function () {
                this.language = "en";
            };

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 col-lg-offset-2" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="https://blog.alswl.com/atom.xml"><i class="fa fa-rss-square fa-lg"></i> RSS</a></li>
                    <li class="list-group-item"><a href="https://twitter.com/alswl"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/alswl"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                    <li class="list-group-item"><a href="http://weibo.com/alswlx"><i class="fa fa-weibo fa-lg"></i> Weibo</a></li>
                  </ul>
                </li>




        </ul>
    </section>

</aside>        </div>
    <div class="col-lg-3" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="https://blog.alswl.com/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                    <ul class="list-group" id="categories">
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/coding/">
                                <i class="fa fa-folder-open fa-lg"></i> Coding
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/efficiency/">
                                <i class="fa fa-folder-open fa-lg"></i> Efficiency
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/fun/">
                                <i class="fa fa-folder-open fa-lg"></i> Fun
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/internet/">
                                <i class="fa fa-folder-open fa-lg"></i> Internet
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/life/">
                                <i class="fa fa-folder-open fa-lg"></i> Life
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/managment/">
                                <i class="fa fa-folder-open fa-lg"></i> Managment
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/sre/">
                                <i class="fa fa-folder-open fa-lg"></i> SRE
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/thinking/">
                                <i class="fa fa-folder-open fa-lg"></i> Thinking
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/ui/">
                                <i class="fa fa-folder-open fa-lg"></i> UI
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://blog.alswl.com/category/viewpoint/">
                                <i class="fa fa-folder-open fa-lg"></i> Viewpoint
                            </a>
                        </li>
                    </ul>
                </li>


        </ul>
    </section>

</aside>    </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2005-2022 alswl
            &middot; Powered by <a href="https://github.com/alswl/pelican-bootstrap3" target="_blank" style="font-weight: bold">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank" style="font-weight: bold">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank" style="font-weight: bold">Bootstrap</a>,
            <p>
              <small> <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license"><img alt="Creative Commons License" style="border-width:0" src="https://4ocf5n.dijingchao.com/upload_dropbox/meta/by-nc-nd_4-0_80x15.png"></a> Content licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license">Creative Commons Attribution 4.0 International-NonCommercial-NoDerivatives License</a>, except where indicated otherwise. </small>
            </p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8822123-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->
</body>
</html>