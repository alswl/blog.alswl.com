<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 | Log4D</title><meta name=keywords content="sqlserver,mysql,db-migration"><meta name=description content="该系列三篇文章已经全部完成：
从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D （image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）
在上篇文章 从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D 中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。 全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的： 迁移过程中需要停机，停机的时长和数据量相关。 对于核心业务来说，停机就意味着损失。 比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。 而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。
能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？ 作为有追求的技术人，我们一定要想办法解决上面的问题。
在线迁移的原理和流程 针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的 yugong 项目。 在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle 的在线迁移。"><meta name=author content="alswl"><link rel=canonical href=https://blog.alswl.com/2018/05/sql-server-migration-2/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.alswl.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.alswl.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.alswl.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.alswl.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.alswl.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-8822123-3","auto"),ga("send","pageview"))</script><meta property="og:title" content="从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机"><meta property="og:description" content="该系列三篇文章已经全部完成：
从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D （image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）
在上篇文章 从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D 中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。 全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的： 迁移过程中需要停机，停机的时长和数据量相关。 对于核心业务来说，停机就意味着损失。 比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。 而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。
能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？ 作为有追求的技术人，我们一定要想办法解决上面的问题。
在线迁移的原理和流程 针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的 yugong 项目。 在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle 的在线迁移。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.alswl.com/2018/05/sql-server-migration-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-21T11:24:36+08:00"><meta property="article:modified_time" content="2018-05-21T11:24:36+08:00"><meta property="og:site_name" content="Log4D"><meta name=twitter:card content="summary"><meta name=twitter:title content="从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机"><meta name=twitter:description content="该系列三篇文章已经全部完成：
从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D （image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）
在上篇文章 从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D 中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。 全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的： 迁移过程中需要停机，停机的时长和数据量相关。 对于核心业务来说，停机就意味着损失。 比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。 而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。
能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？ 作为有追求的技术人，我们一定要想办法解决上面的问题。
在线迁移的原理和流程 针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的 yugong 项目。 在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle 的在线迁移。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.alswl.com/posts/"},{"@type":"ListItem","position":3,"name":"从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机","item":"https://blog.alswl.com/2018/05/sql-server-migration-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机","name":"从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机","description":"该系列三篇文章已经全部完成：\n从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D （image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）\n在上篇文章 从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D 中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。 全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的： 迁移过程中需要停机，停机的时长和数据量相关。 对于核心业务来说，停机就意味着损失。 比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。 而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。\n能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？ 作为有追求的技术人，我们一定要想办法解决上面的问题。\n在线迁移的原理和流程 针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的 yugong 项目。 在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle 的在线迁移。","keywords":["sqlserver","mysql","db-migration"],"articleBody":"该系列三篇文章已经全部完成：\n从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D 从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D 从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D （image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）\n在上篇文章 从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D 中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。 全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的： 迁移过程中需要停机，停机的时长和数据量相关。 对于核心业务来说，停机就意味着损失。 比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。 而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。\n能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？ 作为有追求的技术人，我们一定要想办法解决上面的问题。\n在线迁移的原理和流程 针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的 yugong 项目。 在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle 的在线迁移。\n下图是 yugong 针对 Oracle 到 MySQL 的增量迁移流程：\n这其中有四个步骤：\n增量数据收集 (创建 Oracle 表的增量物化视图) 进行全量复制 进行增量复制 (可并行进行数据校验) 原库停写，切到新库 Oracle 物化视图（Materialized View）是 Oracle 提供的一个机制。 一个物化视图就是主库在某一个时间点上的复制，可以理解为是这个时间点上的 Snapshot。 当主库的数据持续更新时，物化视图的更新可以通过独立的批量更新完成，称之为 refreshes。 一批 refreshes 之间的变化，就对应到数据库的内容变化情况。 物化视图经常用来将主库的数据复制到从库，也常常在数据仓库用来缓存复杂查询。\n物化视图有多种配置方式，这里比较关心刷新方式和刷新时间。 刷新方式有三种：\nComplete Refresh：删除所有数据记录重新生成物化视图 Fast Refresh：增量刷新 Force Refresh：根据条件判断使用 Complete Refresh 和 Fast Refres 刷新机制有两种模式： Refresh-on-commit 和 Refresh-On-Demand。\nOracle 基于物化视图，就可以完成增量数据的获取，从而满足阿里的数据在线迁移。 将这个技术问题泛化一下，想做到在线增量迁移需要有哪些特性？ 我们得到如下结论（针对源数据库）：\n增量变化：支持增量获得增量数据库变化 延迟：获取变化数据这个动作耗时需要尽可能低 幂等一致性：变化数据的消费应当做到幂等，即不管目标数据库已有数据什么状态，都可以无差别消费 回到我们面临的问题上来，SQL Server 是否有这个机制满足这三个特性呢？ 答案是肯定的，SQL Server 官方提供了 CDC 功能。\nCDC 的工作原理 什么是 CDC？ CDC 全称 Change Data Capture，设计目的就是用来解决增量数据的。 它是 SQL Server 2008 新增的特性， 在这之前只能使用 SQl Server 2005 中的 after insert / after delete / after update Trigger 功能来获得数据变化。\nCDC 的工作原理如下：\n当数据库表发生变化时候，Capture process 会从 transaction log 里面获取数据变化， 然后将这些数据记录到 Change Table 里面。 有了这些数据，用户可以通过特定的 CDC 查询函数将这些变化数据查出来。\nCDC 的数据结构和基本使用 CDC 的核心数据就是那些 Change Table 了，这里我们给大家看一下 Change Table 长什么样，可以有个直观的认识。\n通过以下的函数打开一张表（fruits）的 CDC 功能。\n-- enable cdc for db sys.sp_cdc_enable_db; -- enable by table EXEC sys.sp_cdc_enable_table @source_schema = N'dbo', @source_name = N'fruits', @role_name = NULL; -- list cdc enabled table SELECT name, is_cdc_enabled from sys.databases where is_cdc_enabled = 1; 至此 CDC 功能已经开启，如果需要查看哪些表开启了 CDC 功能，可以使用一下 SQL：\n-- list cdc enabled table SELECT name, is_cdc_enabled from sys.databases where is_cdc_enabled = 1; 开启 CDC 会导致产生一张 Change Table 表 cdc.dbo_fruits_CT，这张表的表结构如何呢？\n.schema cdc.dbo_fruits_CT name default nullable type length indexed -------------- ------- -------- ------------ ------ ------- __$end_lsn null YES binary 10 NO __$operation null NO int 4 NO __$seqval null NO binary 10 NO __$start_lsn null NO binary 10 YES __$update_mask null YES varbinary 128 NO id null YES int 4 NO name null YES varchar(255) 255 NO 这张表中以 __ 开头的字段是 CDC 所记录的元数据，id 和 name 是 fruits 表的原始字段。 这意味着 CDC 的表结构和原始表结构是一一对应的。\n接下来我们做一些业务操作，让数据库的数据发生一些变化，然后查看 CDC 的 Change Table：\n-- 1 step DECLARE @begin_time datetime, @end_time datetime, @begin_lsn binary(10), @end_lsn binary(10); -- 2 step SET @begin_time = '2017-09-11 14:03:00.000'; SET @end_time = '2017-09-11 14:10:00.000'; -- 3 step SELECT @begin_lsn = sys.fn_cdc_map_time_to_lsn('smallest greater than', @begin_time); SELECT @end_lsn = sys.fn_cdc_map_time_to_lsn('largest less than or equal', @end_time); -- 4 step SELECT * FROM cdc.fn_cdc_get_all_changes_dbo_fruits(@begin_lsn, @end_lsn, 'all'); 这里的操作含义是：\n定义存储过程中需要使用的 4 个变量 begin_time / end_time 是 Human Readable 的字符串格式时间 begin_lsn / end_lsn 是通过 CDC 函数转化过的 Log Sequence Number，代表数据库变更的唯一操作 ID 根据 begin_lsn / end_lsn 查询到 CDC 变化数据 查询出来的数据如下所示：\n__$start_lsn __$end_lsn __$seqval __$operation __$update_mask id name -------------------- ---------- -------------------- ------------ -------------- -- ------ 0000dede0000019f001a null 0000dede0000019f0018 2 03 1 apple 0000dede000001ad0004 null 0000dede000001ad0003 2 03 2 apple2 0000dede000001ba0003 null 0000dede000001ba0002 3 02 2 apple2 0000dede000001ba0003 null 0000dede000001ba0002 4 02 2 apple3 0000dede000001c10003 null 0000dede000001c10002 2 03 3 apple4 0000dede000001cc0005 null 0000dede000001cc0002 1 03 3 apple4 可以看到 Change Table 已经如实的记录了我们操作内容，注意 __$operation 代表了数据库操作：\n1 =\u003e 删除 2 =\u003e 插入 3 =\u003e 更新前数据 4 =\u003e 更新后数据 根据查出来的数据，我们可以重现这段时间数据库的操作：\n新增了 id 为 1 / 2 的两条数据 更新了 id 为 2 的数据 插入了 id 为 3 的数据 删除了 id 为 3 的数据 CDC 调优 有了 CDC 这个利器，终于意味着我们的方向是没有问题的，我们终于稍稍吁了一口气。 但除了了解原理和使用方式，我们还需要深入了解 CDC 的工作机制，对其进行压测、调优， 了解其极限和边界，否则一旦线上出现不可控的情况，就会对业务带来巨大损失。\n我们先看看 CDC 的工作流程，就可以知道有哪些核心参数可以调整：\n上图是 CDC Job 的工作流程：\n蓝色区域是一次 Log 扫描执行的最大扫描次数：maxscans number（maxscans） 蓝色区域同时被最大扫描 transcation 数量控制：maxtrans 浅蓝色区域是扫描间隔时间，单位是秒：pollinginterval 这三个参数平衡着 CDC 的服务器资源消耗、吞吐量和延迟， 根据具体场景，比如大字段，宽表，BLOB 表，可以调整从而达到满足业务需要。 他们的默认值如下：\nmaxscan 默认值 10 maxtrans 默认值 500 pollinginterval 默认值 5 秒 CDC 压测 掌握了能够调整的核心参数，我们即将对 CDC 进行了多种形式的测试。 在压测之前，我们还需要确定关键的健康指标，这些指标有：\n内存：buffer-cache-hit / page-life-expectancy / page-split 等 吞吐：batch-requets / sql-compilations / sql-re-compilations / transactions count 资源消耗：user-connections / processes-blocked / lock-waits / checkpoint-pages 操作系统层面：CPU 利用率、磁盘 IO 出于篇幅考虑，我们无法将所有测试结果贴出来， 这里放一个在并发 30 下面插入一百万数据（随机数据）进行展示：\n测试结论是，在默认的 CDC 参数下面：\nCDC 的开启/关闭过程中会导致若干个 Process Block， 大流量请求下面（15k TPS）过程会导致约 20 个左右 Process Block。 这个过程中对服务器的 IO / CPU 无明显波动， 开启/关闭瞬间会带来 mssql.sql-statistics.sql-compilations 剧烈波动。 CDC 开启后，在大流量请求下面对 QPS / Page IO 无明显波动， 对服务器的 IO / CPU 也无明显波动， CDC 开启后可以在 16k TPS 下正常工作。\n如果对性能不达标，官方有一些简单的优化指南：\n调整 maxscan maxtrans pollinginterval 减少在插入后立刻插入 避免大批量写操作 限制需要记录的字段 尽可能关闭 net changes 没任务压力时跑 cleanup 监控 log file 大小和 IO 压力，确保不会写爆磁盘 要设置 filegroup_name 开启 sp_cdc_enable_table 之前设置 filegroup yugong 的在线迁移机制 OK，截目前位置，我们已经具备了 CDC 这个工具，但是这仅仅提供了一种可能性， 我们还需要一个工具将 CDC 的数据消费出来，并喂到 MySQL 里面去。\n好在有 yugong。 Yugong 官方提供了 Oracle 到 MySQL 的封装，并且抽象了 Source / Target / SQL Tempalte 等接口， 我们只要实现相关接口，就可以完成从 SQL Server 消费数据到 MySQL 了。\n这里我们不展开，我还会花专门的一篇文章讲如何在 yugong 上面进行开发。 可以提前剧透一下，我们已经将支持 SQL Server 的 yugong 版本开源了。\n如何回滚 数据库迁移这样的项目，我们不仅仅要保证单向从 SQL Server 到 MySQL 的写入， 同时要从 MySQL 写入 SQL Server。\n这个流程同样考虑增量写入的要素：增量消费，延迟，幂等一致性。\nMySQL 的 binlog 可以满足这三个要素，需要注意的是，MySQL binlog 有三种模式， Statement based，Row based 和 Mixed。只有 Row based 才能满足幂等一致性的要求。\n确认理论上可行之后，我们一样需要一个工具将 binlog 读取出来，并且将其转化为 SQL Server 可以消费的数据格式，然后写入 SQL Server。\n我们目光转到 alibaba 的另外一个项目 Canal。 Canal 是阿里中间件团队提供的 binlog 增量订阅 \u0026 消费组件。 之所以叫组件，是由于 Canal 提供了 Canal-Server 应用和 Canal Client Library， Canal 会模拟成一个 MySQL 实例，作为 Slave 连接到 Master 上面， 然后实时将 binlog 读取出来。 至于 binlog 读出之后想怎么使用，权看用户如何使用。\n我们基于 Canal 设计了一个简单的数据流，在 yugong 中增加了这么几个功能：\nSQL Server 的写入功能 消费 Canal 数据源的功能 Canal Server 中的 binlog 只能做一次性消费， 内部实现是一个 Queue， 为了满足我们可以重复消费数据的能力，我们还额外设计了一个环节，将 Canal 的数据放到 Queue 中，在未来任意时间可以重复消费数据。 我们选择了 Redis 作为这个 Queue，数据流如下。\n最佳实践 数据库的迁移在去 Windows 中，是最不容得出错的环节。 应用是无状态的，出现问题可以通过回切较快地回滚。 但数据库的迁移就需要考虑周到，做好资源准备，发布流程， 故障预案处理。\n考虑到多个事业部都需要经历这个一个过程，我们项目组将每一个步骤都固化下来， 形成了一个最佳实践。我们的迁移步骤如下，供大家参考：\n大阶段 阶段 事项 是否完成 负责人 耗时 开始时间 完成时间 备注 白天 存量数据阶段 创建 MySQL 数据库，准备相关账号资源 DBA 开启 CDC DBA 从 Slave SQLServer dump 一份 snapshot 到 Backup SQL Server DBA Backup SQL Server 消费数据， ETL 到 MySQL DBA 增量数据阶段 确认 ETL 数据已经消费完成，检查数据总条数 DBA 从 Slave SQLServer 开始消费 CDC 数据，持续写入 MySQL DBA 使用 yugong 检查一天内数据的一致性 DBA 检查不一致的数据，10 分钟之后人工进行检查，确认是 CDC 延迟带来的问题 DBA 检查数据总量条目 DBA 使用 yugong 对抽样表进行全量检查 DBA 凌晨 应用发布阶段 停止 SQL Server 的应用 技术经理 检查没有连接进入 SQL Server DBA 使用 yugong 检查一天内数据的一致性 DBA 检查数据总量条目 DBA 启用基于 MySQL 的应用 运维 测试阶段 测试应用是否正常，回归所有功能 QA （临时新增）测试 ReadOnly DB 的应用访问情况 QA 完成阶段 接入流量 运维 （可选）回滚阶段 发现问题，直接将应用切回 SQL Server 运维 事后进行数据审计，进行新增数据补偿 DBA （可选）回滚过程中，使用 Canal 读取 binlog，并使用 Canal Client 重放到 SQL Server DBA Reference Materialized View Concepts and Architecture Tuning the Performance of Change Data Capture in SQL Server 2008 | Microsoft Docs alibaba/yugong: 阿里巴巴去Oracle数据迁移同步工具(全量+增量,目标支持MySQL/DRDS) alibaba/canal: 阿里巴巴mysql数据库binlog的增量订阅\u0026消费组件 。阿里云DRDS( https://www.aliyun.com/product/drds )、阿里巴巴TDDL 二级索引、小表复制powerd by canal. ","wordCount":"927","inLanguage":"en","datePublished":"2018-05-21T11:24:36+08:00","dateModified":"2018-05-21T11:24:36+08:00","author":{"@type":"Person","name":"alswl"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.alswl.com/2018/05/sql-server-migration-2/"},"publisher":{"@type":"Organization","name":"Log4D","logo":{"@type":"ImageObject","url":"https://blog.alswl.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.alswl.com accesskey=h title="Log4D (Alt + H)">Log4D</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.alswl.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://blog.alswl.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.alswl.com/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://blog.alswl.com/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.alswl.com>Home</a>&nbsp;»&nbsp;<a href=https://blog.alswl.com/posts/>Posts</a></div><h1 class=post-title>从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机</h1><div class=post-meta><span title='2018-05-21 11:24:36 +0800 +0800'>2018-05-21</span>&nbsp;·&nbsp;alswl</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#在线迁移的原理和流程>在线迁移的原理和流程</a></li><li><a href=#cdc-的工作原理>CDC 的工作原理</a></li><li><a href=#cdc-的数据结构和基本使用>CDC 的数据结构和基本使用</a></li><li><a href=#cdc-调优>CDC 调优</a></li><li><a href=#cdc-压测>CDC 压测</a></li><li><a href=#yugong-的在线迁移机制>yugong 的在线迁移机制</a></li><li><a href=#如何回滚>如何回滚</a></li><li><a href=#最佳实践>最佳实践</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></details></div><div class=post-content><p>该系列三篇文章已经全部完成：</p><ul><li><a href=https://blog.alswl.com/2018/03/sql-server-migration-1/>从 SQL Server 到 MySQL（一）：异构数据库迁移 - Log4D</a></li><li><a href=https://blog.alswl.com/2018/05/sql-server-migration-2/>从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D</a></li><li><a href=https://blog.alswl.com/2018/06/sql-server-migration-3/>从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量 - Log4D</a></li></ul><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/flying-tanker.png alt=flying-tanker></p><p><smaill>（image via <a href=https://pixabay.com/en/military-stealth-bomber-refueling-602729/>https://pixabay.com/en/military-stealth-bomber-refueling-602729/</a> ）</small></p><p>在上篇文章
<a href=https://blog.alswl.com/2018/03/sql-server-migration-1/>从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D</a>
中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。
全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的：
迁移过程中需要停机，停机的时长和数据量相关。
对于核心业务来说，停机就意味着损失。
比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。
而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。</p><p>能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？
作为有追求的技术人，我们一定要想办法解决上面的问题。</p><h2 id=在线迁移的原理和流程>在线迁移的原理和流程<a hidden class=anchor aria-hidden=true href=#在线迁移的原理和流程>#</a></h2><p>针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的
<a href=https://github.com/alibaba/yugong>yugong</a>
项目。
在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle
的在线迁移。</p><p>下图是 yugong 针对 Oracle 到 MySQL 的增量迁移流程：</p><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/yugong-oracle.png alt=yugong-oracle.png></p><p>这其中有四个步骤：</p><ol><li>增量数据收集 (创建 Oracle 表的增量物化视图)</li><li>进行全量复制</li><li>进行增量复制 (可并行进行数据校验)</li><li>原库停写，切到新库</li></ol><p>Oracle 物化视图（Materialized View）是 Oracle 提供的一个机制。
一个物化视图就是主库在某一个时间点上的复制，可以理解为是这个时间点上的 Snapshot。
当主库的数据持续更新时，物化视图的更新可以通过独立的批量更新完成，称之为 <code>refreshes</code>。
一批 <code>refreshes</code> 之间的变化，就对应到数据库的内容变化情况。
物化视图经常用来将主库的数据复制到从库，也常常在数据仓库用来缓存复杂查询。</p><p>物化视图有多种配置方式，这里比较关心刷新方式和刷新时间。
刷新方式有三种：</p><ul><li>Complete Refresh：删除所有数据记录重新生成物化视图</li><li>Fast Refresh：增量刷新</li><li>Force Refresh：根据条件判断使用 Complete Refresh 和 Fast Refres</li></ul><p>刷新机制有两种模式： Refresh-on-commit 和 Refresh-On-Demand。</p><p>Oracle 基于物化视图，就可以完成增量数据的获取，从而满足阿里的数据在线迁移。
将这个技术问题泛化一下，想做到在线增量迁移需要有哪些特性？
我们得到如下结论（针对源数据库）：</p><ul><li>增量变化：支持增量获得增量数据库变化</li><li>延迟：获取变化数据这个动作耗时需要尽可能低</li><li>幂等一致性：变化数据的消费应当做到幂等，即不管目标数据库已有数据什么状态，都可以无差别消费</li></ul><p>回到我们面临的问题上来，SQL Server 是否有这个机制满足这三个特性呢？
答案是肯定的，SQL Server 官方提供了 CDC 功能。</p><h2 id=cdc-的工作原理>CDC 的工作原理<a hidden class=anchor aria-hidden=true href=#cdc-的工作原理>#</a></h2><p>什么是 CDC？
CDC 全称 Change Data Capture，设计目的就是用来解决增量数据的。
它是 SQL Server 2008 新增的特性，
在这之前只能使用 SQl Server 2005 中的 <code>after insert</code> / <code>after delete</code>
/ <code>after update</code> Trigger 功能来获得数据变化。</p><p>CDC 的工作原理如下：</p><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-data-flow.png alt=cdc-data-flow.png></p><p>当数据库表发生变化时候，Capture process 会从 transaction log 里面获取数据变化，
然后将这些数据记录到 Change Table 里面。
有了这些数据，用户可以通过特定的 CDC 查询函数将这些变化数据查出来。</p><h2 id=cdc-的数据结构和基本使用>CDC 的数据结构和基本使用<a hidden class=anchor aria-hidden=true href=#cdc-的数据结构和基本使用>#</a></h2><p>CDC 的核心数据就是那些 Change Table 了，这里我们给大家看一下
Change Table 长什么样，可以有个直观的认识。</p><p>通过以下的函数打开一张表（fruits）的 CDC 功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- enable cdc for db
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sys</span><span class=p>.</span><span class=n>sp_cdc_enable_db</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- enable by table
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXEC</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>sp_cdc_enable_table</span><span class=w> </span><span class=o>@</span><span class=n>source_schema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;dbo&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>source_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;fruits&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>role_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- list cdc enabled table
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>is_cdc_enabled</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>databases</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>is_cdc_enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>至此 CDC 功能已经开启，如果需要查看哪些表开启了 CDC 功能，可以使用一下 SQL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- list cdc enabled table
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>is_cdc_enabled</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>databases</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>is_cdc_enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>开启 CDC 会导致产生一张 Change Table 表 <code>cdc.dbo_fruits_CT</code>，这张表的表结构如何呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>.</span><span class=k>schema</span><span class=w> </span><span class=n>cdc</span><span class=p>.</span><span class=n>dbo_fruits_CT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>name</span><span class=w>            </span><span class=k>default</span><span class=w>  </span><span class=k>nullable</span><span class=w>  </span><span class=k>type</span><span class=w>          </span><span class=k>length</span><span class=w>  </span><span class=n>indexed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------  -------  --------  ------------  ------  -------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>__$end_lsn</span><span class=w>      </span><span class=k>null</span><span class=w>     </span><span class=n>YES</span><span class=w>       </span><span class=nb>binary</span><span class=w>        </span><span class=mi>10</span><span class=w>      </span><span class=k>NO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>__$operation</span><span class=w>    </span><span class=k>null</span><span class=w>     </span><span class=k>NO</span><span class=w>        </span><span class=nb>int</span><span class=w>           </span><span class=mi>4</span><span class=w>       </span><span class=k>NO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>__$seqval</span><span class=w>       </span><span class=k>null</span><span class=w>     </span><span class=k>NO</span><span class=w>        </span><span class=nb>binary</span><span class=w>        </span><span class=mi>10</span><span class=w>      </span><span class=k>NO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>__$start_lsn</span><span class=w>    </span><span class=k>null</span><span class=w>     </span><span class=k>NO</span><span class=w>        </span><span class=nb>binary</span><span class=w>        </span><span class=mi>10</span><span class=w>      </span><span class=n>YES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>__$update_mask</span><span class=w>  </span><span class=k>null</span><span class=w>     </span><span class=n>YES</span><span class=w>       </span><span class=n>varbinary</span><span class=w>     </span><span class=mi>128</span><span class=w>     </span><span class=k>NO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>id</span><span class=w>              </span><span class=k>null</span><span class=w>     </span><span class=n>YES</span><span class=w>       </span><span class=nb>int</span><span class=w>           </span><span class=mi>4</span><span class=w>       </span><span class=k>NO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>name</span><span class=w>            </span><span class=k>null</span><span class=w>     </span><span class=n>YES</span><span class=w>       </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w>  </span><span class=mi>255</span><span class=w>     </span><span class=k>NO</span><span class=w>
</span></span></span></code></pre></div><p>这张表中以 <code>__</code> 开头的字段是 CDC 所记录的元数据，<code>id</code> 和 <code>name</code> 是 fruits 表的原始字段。
这意味着 CDC 的表结构和原始表结构是一一对应的。</p><p>接下来我们做一些业务操作，让数据库的数据发生一些变化，然后查看 CDC 的 Change Table：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 1 step
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DECLARE</span><span class=w> </span><span class=o>@</span><span class=n>begin_time</span><span class=w> </span><span class=n>datetime</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>end_time</span><span class=w> </span><span class=n>datetime</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>begin_lsn</span><span class=w> </span><span class=nb>binary</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span><span class=w> </span><span class=o>@</span><span class=n>end_lsn</span><span class=w> </span><span class=nb>binary</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 2 step
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=o>@</span><span class=n>begin_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2017-09-11 14:03:00.000&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=o>@</span><span class=n>end_time</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2017-09-11 14:10:00.000&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 3 step
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>@</span><span class=n>begin_lsn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>fn_cdc_map_time_to_lsn</span><span class=p>(</span><span class=s1>&#39;smallest greater than&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>begin_time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>@</span><span class=n>end_lsn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>fn_cdc_map_time_to_lsn</span><span class=p>(</span><span class=s1>&#39;largest less than or equal&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>end_time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 4 step
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>cdc</span><span class=p>.</span><span class=n>fn_cdc_get_all_changes_dbo_fruits</span><span class=p>(</span><span class=o>@</span><span class=n>begin_lsn</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>end_lsn</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;all&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>这里的操作含义是：</p><ol><li>定义存储过程中需要使用的 4 个变量</li><li>begin_time / end_time 是 Human Readable 的字符串格式时间</li><li>begin_lsn / end_lsn 是通过 CDC 函数转化过的 Log Sequence Number，代表数据库变更的唯一操作 ID</li><li>根据 begin_lsn / end_lsn 查询到 CDC 变化数据</li></ol><p>查询出来的数据如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>__$start_lsn</span><span class=w>          </span><span class=n>__$end_lsn</span><span class=w>  </span><span class=n>__$seqval</span><span class=w>             </span><span class=n>__$operation</span><span class=w>  </span><span class=n>__$update_mask</span><span class=w>  </span><span class=n>id</span><span class=w>  </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------------  ----------  --------------------  ------------  --------------  --  ------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>0000</span><span class=n>dede0000019f001a</span><span class=w>  </span><span class=k>null</span><span class=w>        </span><span class=mi>0000</span><span class=n>dede0000019f0018</span><span class=w>  </span><span class=mi>2</span><span class=w>             </span><span class=mi>03</span><span class=w>              </span><span class=mi>1</span><span class=w>   </span><span class=n>apple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0000</span><span class=n>dede000001ad0004</span><span class=w>  </span><span class=k>null</span><span class=w>        </span><span class=mi>0000</span><span class=n>dede000001ad0003</span><span class=w>  </span><span class=mi>2</span><span class=w>             </span><span class=mi>03</span><span class=w>              </span><span class=mi>2</span><span class=w>   </span><span class=n>apple2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0000</span><span class=n>dede000001ba0003</span><span class=w>  </span><span class=k>null</span><span class=w>        </span><span class=mi>0000</span><span class=n>dede000001ba0002</span><span class=w>  </span><span class=mi>3</span><span class=w>             </span><span class=mi>02</span><span class=w>              </span><span class=mi>2</span><span class=w>   </span><span class=n>apple2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0000</span><span class=n>dede000001ba0003</span><span class=w>  </span><span class=k>null</span><span class=w>        </span><span class=mi>0000</span><span class=n>dede000001ba0002</span><span class=w>  </span><span class=mi>4</span><span class=w>             </span><span class=mi>02</span><span class=w>              </span><span class=mi>2</span><span class=w>   </span><span class=n>apple3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0000</span><span class=n>dede000001c10003</span><span class=w>  </span><span class=k>null</span><span class=w>        </span><span class=mi>0000</span><span class=n>dede000001c10002</span><span class=w>  </span><span class=mi>2</span><span class=w>             </span><span class=mi>03</span><span class=w>              </span><span class=mi>3</span><span class=w>   </span><span class=n>apple4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0000</span><span class=n>dede000001cc0005</span><span class=w>  </span><span class=k>null</span><span class=w>        </span><span class=mi>0000</span><span class=n>dede000001cc0002</span><span class=w>  </span><span class=mi>1</span><span class=w>             </span><span class=mi>03</span><span class=w>              </span><span class=mi>3</span><span class=w>   </span><span class=n>apple4</span><span class=w>
</span></span></span></code></pre></div><p>可以看到 Change Table 已经如实的记录了我们操作内容，注意 <code>__$operation</code>
代表了数据库操作：</p><ul><li>1 => 删除</li><li>2 => 插入</li><li>3 => 更新前数据</li><li>4 => 更新后数据</li></ul><p>根据查出来的数据，我们可以重现这段时间数据库的操作：</p><ul><li>新增了 <code>id</code> 为 1 / 2 的两条数据</li><li>更新了 <code>id</code> 为 2 的数据</li><li>插入了 <code>id</code> 为 3 的数据</li><li>删除了 <code>id</code> 为 3 的数据</li></ul><h2 id=cdc-调优>CDC 调优<a hidden class=anchor aria-hidden=true href=#cdc-调优>#</a></h2><p>有了 CDC 这个利器，终于意味着我们的方向是没有问题的，我们终于稍稍吁了一口气。
但除了了解原理和使用方式，我们还需要深入了解 CDC 的工作机制，对其进行压测、调优，
了解其极限和边界，否则一旦线上出现不可控的情况，就会对业务带来巨大损失。</p><p>我们先看看 CDC 的工作流程，就可以知道有哪些核心参数可以调整：</p><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-influence.png alt="Influence of capture job parameters"></p><p>上图是 CDC Job 的工作流程：</p><ul><li>蓝色区域是一次 Log 扫描执行的最大扫描次数：maxscans number（<code>maxscans</code>）</li><li>蓝色区域同时被最大扫描 transcation 数量控制：<code>maxtrans</code></li><li>浅蓝色区域是扫描间隔时间，单位是秒：<code>pollinginterval</code></li></ul><p>这三个参数平衡着 CDC 的服务器资源消耗、吞吐量和延迟，
根据具体场景，比如大字段，宽表，BLOB 表，可以调整从而达到满足业务需要。
他们的默认值如下：</p><ul><li><code>maxscan</code> 默认值 10</li><li><code>maxtrans</code> 默认值 500</li><li><code>pollinginterval</code> 默认值 5 秒</li></ul><h2 id=cdc-压测>CDC 压测<a hidden class=anchor aria-hidden=true href=#cdc-压测>#</a></h2><p>掌握了能够调整的核心参数，我们即将对 CDC 进行了多种形式的测试。
在压测之前，我们还需要确定关键的健康指标，这些指标有：</p><ul><li>内存：buffer-cache-hit / page-life-expectancy / page-split 等</li><li>吞吐：batch-requets / sql-compilations / sql-re-compilations / transactions count</li><li>资源消耗：user-connections / processes-blocked / lock-waits / checkpoint-pages</li><li>操作系统层面：CPU 利用率、磁盘 IO</li></ul><p>出于篇幅考虑，我们无法将所有测试结果贴出来，
这里放一个在并发 30 下面插入一百万数据（随机数据）进行展示：</p><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-metrics.png alt=cdc-metrics.png></p><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/cdc-system-load.png alt=cdc-system-load.png></p><p>测试结论是，在默认的 CDC 参数下面：</p><p>CDC 的开启/关闭过程中会导致若干个 Process Block，
大流量请求下面（15k TPS）过程会导致约 20 个左右 Process Block。
这个过程中对服务器的 IO / CPU 无明显波动，
开启/关闭瞬间会带来 mssql.sql-statistics.sql-compilations 剧烈波动。
CDC 开启后，在大流量请求下面对 QPS / Page IO 无明显波动，
对服务器的 IO / CPU 也无明显波动， CDC 开启后可以在 16k TPS 下正常工作。</p><p>如果对性能不达标，官方有一些简单的优化指南：</p><ul><li>调整 maxscan maxtrans pollinginterval</li><li>减少在插入后立刻插入</li><li>避免大批量写操作</li><li>限制需要记录的字段</li><li>尽可能关闭 net changes</li><li>没任务压力时跑 cleanup</li><li>监控 log file 大小和 IO 压力，确保不会写爆磁盘</li><li>要设置 filegroup_name</li><li>开启 sp_cdc_enable_table 之前设置 filegroup</li></ul><h2 id=yugong-的在线迁移机制>yugong 的在线迁移机制<a hidden class=anchor aria-hidden=true href=#yugong-的在线迁移机制>#</a></h2><p>OK，截目前位置，我们已经具备了 CDC 这个工具，但是这仅仅提供了一种可能性，
我们还需要一个工具将 CDC 的数据消费出来，并喂到 MySQL 里面去。</p><p>好在有 yugong。
Yugong 官方提供了 Oracle 到 MySQL 的封装，并且抽象了 Source / Target /
SQL Tempalte 等接口，
我们只要实现相关接口，就可以完成从 SQL Server 消费数据到 MySQL 了。</p><p>这里我们不展开，我还会花专门的一篇文章讲如何在 yugong 上面进行开发。
可以提前剧透一下，我们已经将支持 SQL Server 的 yugong 版本开源了。</p><h2 id=如何回滚>如何回滚<a hidden class=anchor aria-hidden=true href=#如何回滚>#</a></h2><p>数据库迁移这样的项目，我们不仅仅要保证单向从 SQL Server 到 MySQL 的写入，
同时要从 MySQL 写入 SQL Server。</p><p>这个流程同样考虑增量写入的要素：增量消费，延迟，幂等一致性。</p><p>MySQL 的 binlog 可以满足这三个要素，需要注意的是，MySQL binlog 有三种模式，
Statement based，Row based 和 Mixed。只有 Row based 才能满足幂等一致性的要求。</p><p>确认理论上可行之后，我们一样需要一个工具将 binlog 读取出来，并且将其转化为
SQL Server 可以消费的数据格式，然后写入 SQL Server。</p><p>我们目光转到 alibaba 的另外一个项目 Canal。
Canal 是阿里中间件团队提供的 binlog 增量订阅 & 消费组件。
之所以叫组件，是由于 Canal 提供了 Canal-Server 应用和 Canal Client Library，
Canal 会模拟成一个 MySQL 实例，作为 Slave 连接到 Master 上面，
然后实时将 binlog 读取出来。
至于 binlog 读出之后想怎么使用，权看用户如何使用。</p><p>我们基于 Canal 设计了一个简单的数据流，在 yugong 中增加了这么几个功能：</p><ul><li>SQL Server 的写入功能</li><li>消费 Canal 数据源的功能</li></ul><p>Canal Server 中的 binlog 只能做一次性消费，
内部实现是一个 Queue，
为了满足我们可以重复消费数据的能力，我们还额外设计了一个环节，将 Canal
的数据放到 Queue 中，在未来任意时间可以重复消费数据。
我们选择了 Redis 作为这个 Queue，数据流如下。</p><p><img loading=lazy src=https://4ocf5n.dijingchao.com/upload_dropbox/201805/canal.png alt=canal.png></p><h2 id=最佳实践>最佳实践<a hidden class=anchor aria-hidden=true href=#最佳实践>#</a></h2><p>数据库的迁移在去 Windows 中，是最不容得出错的环节。
应用是无状态的，出现问题可以通过回切较快地回滚。
但数据库的迁移就需要考虑周到，做好资源准备，发布流程，
故障预案处理。</p><p>考虑到多个事业部都需要经历这个一个过程，我们项目组将每一个步骤都固化下来，
形成了一个最佳实践。我们的迁移步骤如下，供大家参考：</p><table><thead><tr><th>大阶段</th><th>阶段</th><th>事项</th><th>是否完成</th><th>负责人</th><th>耗时</th><th>开始时间</th><th>完成时间</th><th>备注</th></tr></thead><tbody><tr><td>白天</td><td>存量数据阶段</td><td>创建 MySQL 数据库，准备相关账号资源</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>开启 CDC</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>从 Slave SQLServer dump 一份 snapshot 到 Backup SQL Server</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>Backup SQL Server 消费数据， ETL 到 MySQL</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td>增量数据阶段</td><td>确认 ETL 数据已经消费完成，检查数据总条数</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>从 Slave SQLServer 开始消费 CDC 数据，持续写入 MySQL</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>使用 yugong 检查一天内数据的一致性</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>检查不一致的数据，10 分钟之后人工进行检查，确认是 CDC 延迟带来的问题</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>检查数据总量条目</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>使用 yugong 对抽样表进行全量检查</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td>凌晨</td><td>应用发布阶段</td><td>停止 SQL Server 的应用</td><td> </td><td>技术经理</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>检查没有连接进入 SQL Server</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>使用 yugong 检查一天内数据的一致性</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>检查数据总量条目</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>启用基于 MySQL 的应用</td><td> </td><td>运维</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td>测试阶段</td><td>测试应用是否正常，回归所有功能</td><td> </td><td>QA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>（临时新增）测试 ReadOnly DB 的应用访问情况</td><td> </td><td>QA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td>完成阶段</td><td>接入流量</td><td> </td><td>运维</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td>（可选）回滚阶段</td><td>发现问题，直接将应用切回 SQL Server</td><td> </td><td>运维</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>事后进行数据审计，进行新增数据补偿</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr><tr><td> </td><td> </td><td>（可选）回滚过程中，使用 Canal 读取 binlog，并使用 Canal Client 重放到 SQL Server</td><td> </td><td>DBA</td><td> </td><td> </td><td> </td><td> </td></tr></tbody></table><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://docs.oracle.com/cd/B10500_01/server.920/a96567/repmview.htm>Materialized View Concepts and Architecture</a></li><li><a href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008/dd266396(v=sql.100)">Tuning the Performance of Change Data Capture in SQL Server 2008 | Microsoft Docs</a></li><li><a href=https://github.com/alibaba/yugong>alibaba/yugong: 阿里巴巴去Oracle数据迁移同步工具(全量+增量,目标支持MySQL/DRDS)</a></li><li><a href=https://github.com/alibaba/canal>alibaba/canal: 阿里巴巴mysql数据库binlog的增量订阅&消费组件 。阿里云DRDS( https://www.aliyun.com/product/drds )、阿里巴巴TDDL 二级索引、小表复制powerd by canal.</a></li></ul><hr><p>原文链接: <a href=https://blog.alswl.com/2018/05/sql-server-migration-2/>从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 | Log4D</a></p><p>3a1ff193cee606bd1e2ea554a16353ee</p><p>欢迎关注我的微信公众号：<a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&wechat_redirect">窥豹</a></p><figure><img src=https://4ocf5n.dijingchao.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg alt=窥豹><figcaption aria-hidden=true>窥豹</figcaption></figure><figure><img src=https://4ocf5n.dijingchao.com/upload_dropbox/meta/wechat-pay-s-crop.png alt="如果对你有帮助，给作者 ￥2 买张彩票吧。"><figcaption aria-hidden=true>如果对你有帮助，给作者 ￥2
买张彩票吧。</figcaption></figure></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.alswl.com/tags/sqlserver/>sqlserver</a></li><li><a href=https://blog.alswl.com/tags/mysql/>mysql</a></li><li><a href=https://blog.alswl.com/tags/db-migration/>db-migration</a></li></ul><nav class=paginav><a class=prev href=https://blog.alswl.com/2018/06/sql-server-migration-3/><span class=title>« Prev</span><br><span>从 SQL Server 到 MySQL（三）：愚公移山 - 开源力量</span></a>
<a class=next href=https://blog.alswl.com/2018/04/death-sea-effect/><span class=title>Next »</span><br><span>如何逃离死海效应</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//log4d.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.alswl.com>Log4D</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>