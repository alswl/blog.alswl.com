<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>使用nose做测试 | Log4D</title>
<meta name="keywords" content="python, nose, pylons">
<meta name="description" content="不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用 nose 做单元测试，颇有心得， 在这里分享一下。 1. Pylons中依赖包 先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。 breaker，缓存和Session FormEncode，用户输入检查 Mako，模板渲染 nose，自动化测试 Paste，服">
<meta name="author" content="alswl">
<link rel="canonical" href="https://blog.alswl.com/2011/09/nose/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a3c38bde43550bf3cac1612e16d00b32f53b6d9c71f76ca29687db5d86bca0ea.css" integrity="sha256-o8OL3kNVC/PKwWEuFtALMvU7bZxx92yilofbXYa8oOo=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.alswl.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.alswl.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.alswl.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.alswl.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.alswl.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-8822123-3', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="使用nose做测试" />
<meta property="og:description" content="不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用 nose 做单元测试，颇有心得， 在这里分享一下。 1. Pylons中依赖包 先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。 breaker，缓存和Session FormEncode，用户输入检查 Mako，模板渲染 nose，自动化测试 Paste，服" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.alswl.com/2011/09/nose/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2011-09-22T00:00:00+08:00" />
<meta property="article:modified_time" content="2011-09-22T00:00:00+08:00" /><meta property="og:site_name" content="Log4D" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用nose做测试"/>
<meta name="twitter:description" content="不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用 nose 做单元测试，颇有心得， 在这里分享一下。 1. Pylons中依赖包 先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。 breaker，缓存和Session FormEncode，用户输入检查 Mako，模板渲染 nose，自动化测试 Paste，服"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://blog.alswl.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "使用nose做测试",
      "item": "https://blog.alswl.com/2011/09/nose/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "使用nose做测试",
  "name": "使用nose做测试",
  "description": "不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用 nose 做单元测试，颇有心得， 在这里分享一下。 1. Pylons中依赖包 先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。 breaker，缓存和Session FormEncode，用户输入检查 Mako，模板渲染 nose，自动化测试 Paste，服",
  "keywords": [
    "python", "nose", "pylons"
  ],
  "articleBody": "不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用 nose 做单元测试，颇有心得， 在这里分享一下。\n1. Pylons中依赖包 先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。\nbreaker，缓存和Session FormEncode，用户输入检查 Mako，模板渲染 nose，自动化测试 Paste，服务器 Routes, 路由 Tempita，Paste的模板 Weberror WebOb，提供WSGI请求响应等对象 WebTest，Paste自带的测试小框架， 提供TestResponse和TestRequest两个有用的小东西 Pylons的测试主要使用的其中的 Paste / nose / WebOb / WebTest。 遇到问题的时候，可以去翻一翻上面的文档。\n2. Pylons中测试目录结构 目录结构如下\n├─config ├─controllers ├─lib ├─model ├─public ├─templates └─tests └─functional 目录中的 config / controllers / lib / model / public 在不同的web框架下面可能会略有差别，在这里我不关注他们，我关注 tests / functional 中存放相应的测试脚本，比如 test_user.py\n3. 第一个简单的测试用例 3.1. 撰写单元测试文件 最简单的test脚本如下\nfrom myb.tests import * class TestIndexController(TestController): def test_index(self): pass # Test response... 这里我们从 myb.tests 这个目录下面引入了所有包 （其实起作用的是 __init__.py ）\n__init__.py 如下：\n#!/usr/bin/env python #coding: utf-8 from webob.headers import ResponseHeaders from unittest import TestCase from paste.deploy import loadapp from paste.script.appinstall import SetupCommand from pylons import url from routes.util import URLGenerator from webtest import TestApp import pylons.test __all__ = ['environ', 'url', 'TestController'] # Invoke websetup with the current config file SetupCommand('setup-app').run([pylons.test.pylonsapp.config['__file__']]) environ = {} class TestController(TestCase): def __init__(self, *args, **kwargs): wsgiapp = pylons.test.pylonsapp config = wsgiapp.config self.app = TestApp(wsgiapp) url._push_object(URLGenerator(config['routes.map'], environ)) TestCase.__init__(self, *args, **kwargs) 可以看到，这里使用了 TestController 继承了 TestCase 这个单元测试基类， 并且在里面进行了web应用的环境初始化。\n3.2. 撰写测试配置文件 上文撰写了一个最简单的测试代码，我们接着做一些单元测试配置。\n在app应用的同级文件里面，修改 test.ini 文件。\n[DEFAULT] debug = true #email_to = you@yourdomain.com smtp_server = localhost error_email_from = paste@localhost [server:main] use = egg:Paste#http host = 127.0.0.1 port = 5000 [app:main] use = config:development.ini sqlalchemy.url = mysql://username:password@localhost/myb_test?charset=utf8\u0026use_unicode=1 # Logging configuration [loggers] keys = root, routes, myb, sqlalchemy [handlers] keys = console [formatters] keys = generic [logger_root] level = INFO handlers = console [logger_routes] level = INFO handlers = qualname = routes.middleware # \"level = DEBUG\" logs the route matched and routing variables. [logger_myb] level = DEBUG handlers = qualname = myb [logger_sqlalchemy] level = INFO handlers = qualname = sqlalchemy.engine # \"level = INFO\" logs SQL queries. # \"level = DEBUG\" logs SQL queries and results. # \"level = WARN\" logs neither. (Recommended for production systems.) [handler_console] class = StreamHandler args = (sys.stderr,) level = NOTSET formatter = generic [formatter_generic] format = %(asctime)s,%(msecs)03d %(levelname)-5.5s [%(name)s] [%(threadName)s] %(message)s datefmt = %H:%M:%S 这个配置文件设定了基本调试信息，数据库（使用myb_test数据库来避免修改原始数据） ，log方式。\n在 [app:main] 里面，我直接引用了 development.ini 的配置。\n3.3. 运行nose 在shell里面切换到app所在的目录（test.ini）所在的目录，运行 nosetests myb/tests/functional/test_hello world.py 。 之后会出现一些log内容，不出意外的话，应该出现 OK 。\n如果遇到 FAILED ，那就根据错误提示的信息来查错。 nose会输出log的信息和print标准输出的信息。\n4. 高级一点的测试方法 在开发过程中，我们需要判定单元测试是否正确，我罗列一些常见的用法\n4.1. 测试返回类型为HTTP STATUS的方法 每次HTTP请求都会返回HTTP STATUS，正常是200，找不到是404，服务器错误是500， 我们可以根据这些返回状态值来判断测试是否跑通。\nclass TestQuestionController(TestController): def test_suggest_question(self): #正常返回200 response = self.app.get(url=url(controller='question', action='suggest_question', ), params={ }, headers=self.headers, status=200, ) #不存在的id返回404\nresponse = self.app.get(url=url(controller='question', action='suggest_question', ), params={ 'id': '345', }, headers=self.headers, status=404, ) 我习惯使用 url() 方法来生成url，这样一方面不用记住冗长的url， 另外在url路由表发生变化之后，也不用去改变测试代码。\n4.2. 测试返回类型为html的方法 def test_register(self): response = self.app.post(url(controller = 'users', action = 'register', format = 'json'), { 'login_name': 'nose_json', 'login_pass': '123', 'user_name': '测试机器人_json', }, status=200 ) assert '202cb962ac59075b964b07152d234b70' in response.body #返回的加密密码 #log.debug( u'器' in response.unicode_body) #无法测试中文 #log.debug( u'测试机器人_json' in response.unicode_body) #无法测试中文 使用 response.body 来判定html里面的内容（这里对中文支持不太好）。\n4.3. 测试返回类型为json的方法 AJAX请求正常返回的状态吗都是200，我们需要判定里面的内容进行assert\nresponse = self.app.post(url=url(controller='invitation', action='invite_by_mail'), params={ 'to_address': '', 'to_user_name': '大爷', }, headers=self.headers, status=200 ) result = response.json assert(result['success'] == False) assert(result['message'] == u'发送失败：你妹不漂亮') 4.4. 测试返回类型为重定向的方法 这是HTTP状态吗的特殊形式，比如登录之后做一次跳转之类的。\ndef test_add(self): #成功之后返回302做跳转，同时判定返回内容中跳转路径 response = self.app.post(url=url(controller='question', action='add', ), params={ 'question_title': 'hwti1', 'question_content': 'wgtinzrs1', }, headers=self.headers, status=302, ) assert re.match(r'^http://localhost/question/d*', response.headers['Location']) 4.5. 用户登录生成Session 有些方法需要登录后才能运行，这依赖于服务器和浏览器之间的Cookie。如果要对这类 方法进行测试，我们需要事先获取Cookie，再在每一次请求发出的时候附带这个Cookie。\n在下面的方法中，我实现了用户登录操作。 在test目录下的 __init.py__ 中 TestController 加入新方法 login()\ndef login(self, login_name, login_pass): \"\"\" 用户登录操作，获取Cookie \"\"\" response = self.app.post(url=url(controller='users', action='login'), params={ 'login_name': login_name, 'login_pass': login_pass, }, ) cookie = response.headers.getall('Set-cookie')[0] self.headers = ResponseHeaders() self.headers.add('Cookie', cookie) 这样就可以通过 self.headers 保存登录之后的cookie。\n4.6. 批量测试 除了制定 test_xxx.py 文件进行单元测试，我们还可以直接使用 nosetests 测试所有测试用例。\nnosetests //该目录下需要存在 test.ini 配置文件 5. 遇到的问题 5.1. 编码问题 File \"buildbdist.win32eggwebtest__init__.py\", line 211, in post content_type=content_type) File \"buildbdist.win32eggwebtest__init__.py\", line 191, in _gen_request expect_errors=expect_errors) File \"buildbdist.win32eggwebtest__init__.py\", line 370, in do_request res = req.get_response(app, catch_exc_info=True) File \"buildbdist.win32eggwebobrequest.py\", line 1004, in get_response application, catch_exc_info=True) File \"buildbdist.win32eggwebobrequest.py\", line 977, in call_application app_iter = application(self.environ, start_response) File \"buildbdist.win32eggwebtestlint.py\", line 170, in lint_app iterator = application(environ, start_response_wrapper) File \"d:programmingpython26libsite-packagespaste-1.7.5.1-py2.6.eggpastecascade.py\", line 130, in __call__ return self.apps[-1](environ, start_response) File \"d:programmingpython26libsite-packagespaste-1.7.5.1-py2.6.eggpasteregistry.py\", line 379, in __call__ app_iter = self.application(environ, start_response) File \"d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsmiddleware.py\", line 150, in __call__ self.app, environ, catch_exc_info=True) File \"d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsutil.py\", line 48, in call_wsgi_application app_iter = application(environ, start_response) File \"d:programmingpython26libsite-packagesweberror-0.10.3-py2.6.eggweberrorevalexception.py\", line 235, in __call__ return self.respond(environ, start_response) File \"d:programmingpython26libsite-packagesweberror-0.10.3-py2.6.eggweberrorevalexception.py\", line 418, in respond return self.application(environ, start_response) File \"d:programmingpython26libsite-packagesbeaker-1.5.4-py2.6.eggbeakermiddleware.py\", line 152, in __call__ return self.wrap_app(environ, session_start_response) File \"d:programmingpython26libsite-packagesroutes-1.12.3-py2.6.eggroutesmiddleware.py\", line 131, in __call__ response = self.app(environ, start_response) File \"d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonswsgiapp.py\", line 107, in __call__ response = self.dispatch(controller, environ, start_response) File \"d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonswsgiapp.py\", line 312, in dispatch return controller(environ, start_response) File \"F:workxintongworkspaceMYB_WENDAmybmyblibbase.py\", line 52, in __call__ return WSGIController.__call__(self, environ, start_response) File \"d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonscontrollerscore.py\", line 266, in __call__ return response(environ, self.start_response) File \"d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py\", line 517, in __call__ environ, start_response) File \"d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py\", line 341, in __call__ return self.generate_response(environ, start_response) File \"d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py\", line 322, in generate_response body = self.plain_body(environ) File \"d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py\", line 301, in plain_body body = self._make_body(environ, no_escape) File \"d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py\", line 294, in _make_body args[k] = escape(v) File \"d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py\", line 182, in no_escape value = str(value) File \"d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsutil.py\", line 112, in __repr__ value_repr = repr(value) UnicodeEncodeError: 'ascii' codec can't encode characters in position 8-18: ordinal not in range(128) 这是一个明显由编码引起的错误。\n修改pylons-1.0-py2.6.eggPylonsutil.py中112行修改为\ntry: value_repr = repr(value) except UnicodeEncodeError, e: log.error('encode error in pylons/utils.py') continue 这样虽然不能从根本上解决问题，但是至少规避了问题。\n",
  "wordCount" : "2271",
  "inLanguage": "en",
  "datePublished": "2011-09-22T00:00:00+08:00",
  "dateModified": "2011-09-22T00:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "alswl"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.alswl.com/2011/09/nose/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Log4D",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.alswl.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.alswl.com" accesskey="h" title="Log4D (Alt + H)">Log4D</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://en.blog.alswl.com/" title="English Blog">
                    <span>English Blog</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/archives/" title="存档">
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="https://blog.alswl.com/about/" title="关于我">
                    <span>关于我</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.alswl.com">Home</a>&nbsp;»&nbsp;<a href="https://blog.alswl.com/posts/">Posts</a></div>
    <h1 class="post-title">
      使用nose做测试
    </h1>
    <div class="post-meta"><span title='2011-09-22 00:00:00 +0800 +0800'>2011-09-22</span>&nbsp;·&nbsp;alswl

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-pylons中依赖包">1. Pylons中依赖包</a></li>
    <li><a href="#2-pylons中测试目录结构">2. Pylons中测试目录结构</a></li>
    <li><a href="#3-第一个简单的测试用例">3. 第一个简单的测试用例</a>
      <ul>
        <li><a href="#31-撰写单元测试文件">3.1. 撰写单元测试文件</a></li>
        <li><a href="#32-撰写测试配置文件">3.2. 撰写测试配置文件</a></li>
        <li><a href="#33-运行nose">3.3. 运行nose</a></li>
      </ul>
    </li>
    <li><a href="#4-高级一点的测试方法">4. 高级一点的测试方法</a>
      <ul>
        <li><a href="#41-测试返回类型为http-status的方法">4.1. 测试返回类型为HTTP STATUS的方法</a></li>
        <li><a href="#42-测试返回类型为html的方法">4.2. 测试返回类型为html的方法</a></li>
        <li><a href="#43-测试返回类型为json的方法">4.3. 测试返回类型为json的方法</a></li>
        <li><a href="#44-测试返回类型为重定向的方法">4.4. 测试返回类型为重定向的方法</a></li>
        <li><a href="#45-用户登录生成session">4.5. 用户登录生成Session</a></li>
        <li><a href="#46-批量测试">4.6. 批量测试</a></li>
      </ul>
    </li>
    <li><a href="#5-遇到的问题">5. 遇到的问题</a>
      <ul>
        <li><a href="#51-编码问题">5.1. 编码问题</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用
<a href="http://readthedocs.org/docs/nose/en/latest">nose</a> 做单元测试，颇有心得， 在这里分享一下。</p>
<h2 id="1-pylons中依赖包">1. Pylons中依赖包<a hidden class="anchor" aria-hidden="true" href="#1-pylons中依赖包">#</a></h2>
<p>先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。</p>
<ul>
<li><a href="https://github.com/danielfm/pybreaker">breaker，缓存和Session</a></li>
<li><a href="http://formencode.org/">FormEncode，用户输入检查</a></li>
<li><a href="http://www.makotemplates.org/">Mako，模板渲染</a></li>
<li><a href="http://readthedocs.org/docs/nose/en/latest/">nose，自动化测试</a></li>
<li><a href="http://pythonpaste.org/script/">Paste，服务器</a></li>
<li><a href="http://routes.groovie.org/">Routes, 路由</a></li>
<li><a href="http://pythonpaste.org/tempita/">Tempita，Paste的模板</a></li>
<li><a href="http://packages.python.org/WebCore/modules/thirdparty/weberror.html">Weberror</a></li>
<li><a href="http://docs.webob.org/en/latest/index.html">WebOb，提供WSGI请求响应等对象</a></li>
<li><a href="http://pythonpaste.org/webtest/">WebTest，Paste自带的测试小框架， 提供TestResponse和TestRequest两个有用的小东西</a></li>
</ul>
<p>Pylons的测试主要使用的其中的 Paste / nose / WebOb / WebTest。 遇到问题的时候，可以去翻一翻上面的文档。</p>
<h2 id="2-pylons中测试目录结构">2. Pylons中测试目录结构<a hidden class="anchor" aria-hidden="true" href="#2-pylons中测试目录结构">#</a></h2>
<p>目录结构如下</p>
<pre tabindex="0"><code>├─config
├─controllers
├─lib
├─model
├─public
├─templates
└─tests
    └─functional
</code></pre><p>目录中的 <code>config / controllers / lib / model / public</code>
在不同的web框架下面可能会略有差别，在这里我不关注他们，我关注 <code>tests / functional</code> 中存放相应的测试脚本，比如
<code>test_user.py</code></p>
<h2 id="3-第一个简单的测试用例">3. 第一个简单的测试用例<a hidden class="anchor" aria-hidden="true" href="#3-第一个简单的测试用例">#</a></h2>
<h3 id="31-撰写单元测试文件">3.1. 撰写单元测试文件<a hidden class="anchor" aria-hidden="true" href="#31-撰写单元测试文件">#</a></h3>
<p>最简单的test脚本如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">myb.tests</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestIndexController</span><span class="p">(</span><span class="n">TestController</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Test response...</span>
</span></span></code></pre></div><p>这里我们从 <code>myb.tests</code> 这个目录下面引入了所有包 （其实起作用的是 <code>__init__.py</code> ）</p>
<p><code>__init__.py</code> 如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="c1">#coding: utf-8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">webob.headers</span> <span class="kn">import</span> <span class="n">ResponseHeaders</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">paste.script.appinstall</span> <span class="kn">import</span> <span class="n">SetupCommand</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">url</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">routes.util</span> <span class="kn">import</span> <span class="n">URLGenerator</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">webtest</span> <span class="kn">import</span> <span class="n">TestApp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pylons.test</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;environ&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;TestController&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Invoke websetup with the current config file</span>
</span></span><span class="line"><span class="cl"><span class="n">SetupCommand</span><span class="p">(</span><span class="s1">&#39;setup-app&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">pylons</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">pylonsapp</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">environ</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestController</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">wsgiapp</span> <span class="o">=</span> <span class="n">pylons</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">pylonsapp</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">wsgiapp</span><span class="o">.</span><span class="n">config</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">TestApp</span><span class="p">(</span><span class="n">wsgiapp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span><span class="o">.</span><span class="n">_push_object</span><span class="p">(</span><span class="n">URLGenerator</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;routes.map&#39;</span><span class="p">],</span> <span class="n">environ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TestCase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></div><p>可以看到，这里使用了 <code>TestController</code> 继承了 <code>TestCase</code> 这个单元测试基类， 并且在里面进行了web应用的环境初始化。</p>
<h3 id="32-撰写测试配置文件">3.2. 撰写测试配置文件<a hidden class="anchor" aria-hidden="true" href="#32-撰写测试配置文件">#</a></h3>
<p>上文撰写了一个最简单的测试代码，我们接着做一些单元测试配置。</p>
<p>在app应用的同级文件里面，修改 <code>test.ini</code> 文件。</p>
<pre tabindex="0"><code>[DEFAULT]
debug = true
#email_to = you@yourdomain.com
smtp_server = localhost
error_email_from = paste@localhost

[server:main]
use = egg:Paste#http
host = 127.0.0.1
port = 5000

[app:main]
use = config:development.ini
sqlalchemy.url = mysql://username:password@localhost/myb_test?charset=utf8&amp;use_unicode=1

# Logging configuration
[loggers]
keys = root, routes, myb, sqlalchemy

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = INFO
handlers = console

[logger_routes]
level = INFO
handlers =
qualname = routes.middleware

# &#34;level = DEBUG&#34; logs the route matched and routing variables.
[logger_myb]
level = DEBUG
handlers =
qualname = myb

[logger_sqlalchemy]
level = INFO
handlers =
qualname = sqlalchemy.engine

# &#34;level = INFO&#34; logs SQL queries.
# &#34;level = DEBUG&#34; logs SQL queries and results.
# &#34;level = WARN&#34; logs neither. (Recommended for production systems.)

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(asctime)s,%(msecs)03d %(levelname)-5.5s [%(name)s] [%(threadName)s] %(message)s
datefmt = %H:%M:%S
</code></pre><p>这个配置文件设定了基本调试信息，数据库（使用myb_test数据库来避免修改原始数据） ，log方式。</p>
<p>在 <code>[app:main]</code> 里面，我直接引用了 <code>development.ini</code> 的配置。</p>
<h3 id="33-运行nose">3.3. 运行nose<a hidden class="anchor" aria-hidden="true" href="#33-运行nose">#</a></h3>
<p>在shell里面切换到app所在的目录（test.ini）所在的目录，运行 <code>nosetests myb/tests/functional/test_hello world.py</code> 。 之后会出现一些log内容，不出意外的话，应该出现 <code>OK</code> 。</p>
<p>如果遇到 <code>FAILED</code> ，那就根据错误提示的信息来查错。 nose会输出log的信息和print标准输出的信息。</p>
<h2 id="4-高级一点的测试方法">4. 高级一点的测试方法<a hidden class="anchor" aria-hidden="true" href="#4-高级一点的测试方法">#</a></h2>
<p>在开发过程中，我们需要判定单元测试是否正确，我罗列一些常见的用法</p>
<h3 id="41-测试返回类型为http-status的方法">4.1. 测试返回类型为HTTP STATUS的方法<a hidden class="anchor" aria-hidden="true" href="#41-测试返回类型为http-status的方法">#</a></h3>
<p>每次HTTP请求都会返回HTTP STATUS，正常是200，找不到是404，服务器错误是500， 我们可以根据这些返回状态值来判断测试是否跑通。</p>
<pre tabindex="0"><code>class TestQuestionController(TestController):

  def test_suggest_question(self):

    #正常返回200
    response = self.app.get(url=url(controller=&#39;question&#39;,
    action=&#39;suggest_question&#39;,
    ),

    params={
    },
    headers=self.headers,
    status=200,
    )
</code></pre><p>#不存在的id返回404</p>
<pre tabindex="0"><code>response = self.app.get(url=url(controller=&#39;question&#39;,

action=&#39;suggest_question&#39;,

),

params={

&#39;id&#39;: &#39;345&#39;,

},

headers=self.headers,

status=404,

)
</code></pre><p>我习惯使用 <code>url()</code> 方法来生成url，这样一方面不用记住冗长的url， 另外在url路由表发生变化之后，也不用去改变测试代码。</p>
<h3 id="42-测试返回类型为html的方法">4.2. 测试返回类型为html的方法<a hidden class="anchor" aria-hidden="true" href="#42-测试返回类型为html的方法">#</a></h3>
<pre tabindex="0"><code>        def test_register(self):
            response = self.app.post(url(controller = &#39;users&#39;,
                                         action = &#39;register&#39;,
                                         format = &#39;json&#39;),
                                     {
                                         &#39;login_name&#39;: &#39;nose_json&#39;,
                                         &#39;login_pass&#39;: &#39;123&#39;,
                                         &#39;user_name&#39;: &#39;测试机器人_json&#39;,
                                     },
                                     status=200
                                     )
            assert &#39;202cb962ac59075b964b07152d234b70&#39; in response.body #返回的加密密码
            #log.debug( u&#39;器&#39; in response.unicode_body) #无法测试中文
            #log.debug( u&#39;测试机器人_json&#39; in response.unicode_body) #无法测试中文
</code></pre><p>使用 <code>response.body</code> 来判定html里面的内容（这里对中文支持不太好）。</p>
<h3 id="43-测试返回类型为json的方法">4.3. 测试返回类型为json的方法<a hidden class="anchor" aria-hidden="true" href="#43-测试返回类型为json的方法">#</a></h3>
<p>AJAX请求正常返回的状态吗都是200，我们需要判定里面的内容进行assert</p>
<pre tabindex="0"><code>            response = self.app.post(url=url(controller=&#39;invitation&#39;,
                                             action=&#39;invite_by_mail&#39;),
                                     params={
                                         &#39;to_address&#39;: &#39;&#39;,
                                         &#39;to_user_name&#39;: &#39;大爷&#39;,
                                     },
                                     headers=self.headers,
                                     status=200
                                    )
            result = response.json
            assert(result[&#39;success&#39;] == False)
            assert(result[&#39;message&#39;] == u&#39;发送失败：你妹不漂亮&#39;)
</code></pre><h3 id="44-测试返回类型为重定向的方法">4.4. 测试返回类型为重定向的方法<a hidden class="anchor" aria-hidden="true" href="#44-测试返回类型为重定向的方法">#</a></h3>
<p>这是HTTP状态吗的特殊形式，比如登录之后做一次跳转之类的。</p>
<pre tabindex="0"><code>        def test_add(self):
            #成功之后返回302做跳转，同时判定返回内容中跳转路径
            response = self.app.post(url=url(controller=&#39;question&#39;,
                                             action=&#39;add&#39;,
                                             ),
                                     params={
                                         &#39;question_title&#39;: &#39;hwti1&#39;,
                                         &#39;question_content&#39;: &#39;wgtinzrs1&#39;,
                                     },
                                     headers=self.headers,
                                     status=302,
                                    )
            assert re.match(r&#39;^http://localhost/question/d*&#39;,
                            response.headers[&#39;Location&#39;])
</code></pre><h3 id="45-用户登录生成session">4.5. 用户登录生成Session<a hidden class="anchor" aria-hidden="true" href="#45-用户登录生成session">#</a></h3>
<p>有些方法需要登录后才能运行，这依赖于服务器和浏览器之间的Cookie。如果要对这类
方法进行测试，我们需要事先获取Cookie，再在每一次请求发出的时候附带这个Cookie。</p>
<p>在下面的方法中，我实现了用户登录操作。 在test目录下的 <code>__init.py__</code> 中 <code>TestController</code> 加入新方法 <code>login()</code></p>
<pre tabindex="0"><code>        def login(self, login_name, login_pass):
            &#34;&#34;&#34;
            用户登录操作，获取Cookie

&#34;&#34;&#34;

response = self.app.post(url=url(controller=&#39;users&#39;,

action=&#39;login&#39;),

params={

&#39;login_name&#39;: login_name,

&#39;login_pass&#39;: login_pass,

},

)

cookie = response.headers.getall(&#39;Set-cookie&#39;)[0]

self.headers = ResponseHeaders()

self.headers.add(&#39;Cookie&#39;, cookie)
</code></pre><p>这样就可以通过 <code>self.headers</code> 保存登录之后的cookie。</p>
<h3 id="46-批量测试">4.6. 批量测试<a hidden class="anchor" aria-hidden="true" href="#46-批量测试">#</a></h3>
<p>除了制定 <code>test_xxx.py</code> 文件进行单元测试，我们还可以直接使用 <code>nosetests</code> 测试所有测试用例。</p>
<pre><code>nosetests
//该目录下需要存在 test.ini 配置文件
</code></pre>
<h2 id="5-遇到的问题">5. 遇到的问题<a hidden class="anchor" aria-hidden="true" href="#5-遇到的问题">#</a></h2>
<h3 id="51-编码问题">5.1. 编码问题<a hidden class="anchor" aria-hidden="true" href="#51-编码问题">#</a></h3>
<pre tabindex="0"><code>      File &#34;buildbdist.win32eggwebtest__init__.py&#34;, line 211, in post
        content_type=content_type)
      File &#34;buildbdist.win32eggwebtest__init__.py&#34;, line 191, in _gen_request
        expect_errors=expect_errors)
      File &#34;buildbdist.win32eggwebtest__init__.py&#34;, line 370, in do_request
        res = req.get_response(app, catch_exc_info=True)
      File &#34;buildbdist.win32eggwebobrequest.py&#34;, line 1004, in get_response
        application, catch_exc_info=True)
      File &#34;buildbdist.win32eggwebobrequest.py&#34;, line 977, in call_application
        app_iter = application(self.environ, start_response)
      File &#34;buildbdist.win32eggwebtestlint.py&#34;, line 170, in lint_app
        iterator = application(environ, start_response_wrapper)
      File &#34;d:programmingpython26libsite-packagespaste-1.7.5.1-py2.6.eggpastecascade.py&#34;, line 130, in __call__
        return self.apps[-1](environ, start_response)
      File &#34;d:programmingpython26libsite-packagespaste-1.7.5.1-py2.6.eggpasteregistry.py&#34;, line 379, in __call__
        app_iter = self.application(environ, start_response)
      File &#34;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsmiddleware.py&#34;, line 150, in __call__
        self.app, environ, catch_exc_info=True)
      File &#34;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsutil.py&#34;, line 48, in call_wsgi_application
        app_iter = application(environ, start_response)
      File &#34;d:programmingpython26libsite-packagesweberror-0.10.3-py2.6.eggweberrorevalexception.py&#34;, line 235, in __call__
        return self.respond(environ, start_response)
      File &#34;d:programmingpython26libsite-packagesweberror-0.10.3-py2.6.eggweberrorevalexception.py&#34;, line 418, in respond
        return self.application(environ, start_response)
      File &#34;d:programmingpython26libsite-packagesbeaker-1.5.4-py2.6.eggbeakermiddleware.py&#34;, line 152, in __call__
        return self.wrap_app(environ, session_start_response)
      File &#34;d:programmingpython26libsite-packagesroutes-1.12.3-py2.6.eggroutesmiddleware.py&#34;, line 131, in __call__
        response = self.app(environ, start_response)
      File &#34;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonswsgiapp.py&#34;, line 107, in __call__
        response = self.dispatch(controller, environ, start_response)
      File &#34;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonswsgiapp.py&#34;, line 312, in dispatch
        return controller(environ, start_response)
      File &#34;F:workxintongworkspaceMYB_WENDAmybmyblibbase.py&#34;, line 52, in __call__
        return WSGIController.__call__(self, environ, start_response)
      File &#34;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonscontrollerscore.py&#34;, line 266, in __call__
        return response(environ, self.start_response)
      File &#34;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&#34;, line 517, in __call__
        environ, start_response)
      File &#34;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&#34;, line 341, in __call__
        return self.generate_response(environ, start_response)
      File &#34;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&#34;, line 322, in generate_response
        body = self.plain_body(environ)
      File &#34;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&#34;, line 301, in plain_body
        body = self._make_body(environ, no_escape)
      File &#34;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&#34;, line 294, in _make_body
        args[k] = escape(v)
      File &#34;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&#34;, line 182, in no_escape
        value = str(value)
      File &#34;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsutil.py&#34;, line 112, in __repr__
        value_repr = repr(value)
    UnicodeEncodeError: &#39;ascii&#39; codec can&#39;t encode characters in position 8-18: ordinal not in range(128)
</code></pre><p>这是一个明显由编码引起的错误。</p>
<p>修改pylons-1.0-py2.6.eggPylonsutil.py中112行修改为</p>
<pre tabindex="0"><code>    try:
        value_repr = repr(value)
    except UnicodeEncodeError, e:
        log.error(&#39;encode error in pylons/utils.py&#39;)
        continue
</code></pre><p>这样虽然不能从根本上解决问题，但是至少规避了问题。</p>

<hr />
<p>原文链接: <a href="https://blog.alswl.com/2011/09/nose/">使用nose做测试 | Log4D</a></p>
<p>3a1ff193cee606bd1e2ea554a16353ee</p>
<p>欢迎关注我的微信公众号：<a
href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect">窥豹</a></p>
<figure>
<img
src="https://4ocf5n.dijingchao.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"
alt="窥豹" />
<figcaption aria-hidden="true">窥豹</figcaption>
</figure>
<figure>
<img
src="https://4ocf5n.dijingchao.com/upload_dropbox/meta/wechat-pay-s-crop.png"
alt="如果对你有帮助，给作者 ￥2 买张彩票吧。" />
<figcaption aria-hidden="true">如果对你有帮助，给作者 ￥2
买张彩票吧。</figcaption>
</figure>

    
  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.alswl.com/tags/python/">python</a></li>
      <li><a href="https://blog.alswl.com/tags/nose/">nose</a></li>
      <li><a href="https://blog.alswl.com/tags/pylons/">pylons</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.alswl.com/2011/09/interlace-progressive-image/">
    <span class="title">« Prev</span>
    <br>
    <span>网页渐进式载入图片</span>
  </a>
  <a class="next" href="https://blog.alswl.com/2011/09/jwj/">
    <span class="title">Next »</span>
    <br>
    <span>倾诉</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "log4d" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://blog.alswl.com">Log4D</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
