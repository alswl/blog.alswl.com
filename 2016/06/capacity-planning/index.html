<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>搞定暴涨的流量 - Log4D</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="block-all-mixed-content">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />



<link rel="canonical" href="http://127.0.0.1:8000/2016/06/capacity-planning/">

        <meta name="author" content="alswl" />
        <meta name="keywords" content="Capacity,SRE,Architect" />
        <meta name="description" content="2013 年左右，我司业务发展迅速，每天晚上都会面临服务器濒临崩溃情况。 我相信每个高速发展的互联网企业在某个阶段都会面临这样的情形，比如去年爆红的「足迹」。 过程往往是：线上出现故障，手机会收到报警，然后登录到服务器上去解决问题。 处理这种问题工种现在有一个时髦的名称，叫做「SRE（Site Reliability Engineer）」系统可用性工程师。 虽然我常常救火，但是我还是想尽可能避免线上发生故障。「最好的消息，就是没有消息。」 减少故障出现概率，增强系统可用性，降低故障处理时间是 SRE 的最大课题。 在这里有最常用的两个手段，一个是优化性能，一个是做好容量规划和扩展。 这里我着重讨论后者「容量规划」。 看我的一堆报警消息 ^ 看我的一堆报警消息" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cdn.staticfile.org/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://127.0.0.1:8000/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://127.0.0.1:8000/theme/css/style.css" type="text/css"/>

    <link href="http://127.0.0.1:8000/atom.xml" type="application/atom+xml" rel="alternate" title="Log4D Atom Feed" />
    <link href="http://127.0.0.1:8000/rss.xml" type="application/rss+xml" rel="alternate" title="Log4D RSS Feed" />

</head>
<body>

<div class="navbar navbar-default" role="navigation">
    <div class="container  col-lg-8 col-lg-offset-2">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://127.0.0.1:8000/" class="navbar-brand">
Log4D            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/tags/">Tags</a></li>
                    <li><a href="/links/">Links</a></li>
                    <li><a href="/about/">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://127.0.0.1:8000/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2">

    <section id="content">
        <article class="article-detail">
            <header class="page-header">
                <h1 class="title">
                    <a href="http://127.0.0.1:8000/2016/06/capacity-planning/"
                       rel="bookmark"
                       title="Permalink to 搞定暴涨的流量">
                        搞定暴涨的流量
                    </a>
                </h1>
                <nav class="toc col-lg-2">
                  <div id="toc"><ul><li><a class="toc-href" href="#面临的问题" title="面临的问题">面临的问题</a></li><li><a class="toc-href" href="#设定容量目标" title="设定容量目标">设定容量目标</a></li><li><a class="toc-href" href="#测量" title="测量">测量</a></li><li><a class="toc-href" href="#预警和提醒" title="预警和提醒">预警和提醒</a></li><li><a class="toc-href" href="#必选项---scalable" title="必选项 - Scalable">必选项 - Scalable</a></li><li><a class="toc-href" href="#end" title="End">End</a></li></ul></div>
                </nav>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-06-19T23:57:39+08:00"> 2016-06-19</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://127.0.0.1:8000/tag/capacity/">Capacity</a>
        /
	<a href="http://127.0.0.1:8000/tag/sre/">SRE</a>
        /
	<a href="http://127.0.0.1:8000/tag/architect/">Architect</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>2013 年左右，我司业务发展迅速，每天晚上都会面临服务器濒临崩溃情况。 我相信每个高速发展的互联网企业在某个阶段都会面临这样的情形，比如去年爆红的「足迹」。 过程往往是：线上出现故障，手机会收到报警，然后登录到服务器上去解决问题。 处理这种问题工种现在有一个时髦的名称，叫做「SRE（Site Reliability Engineer）」系统可用性工程师。</p>
<p>虽然我常常救火，但是我还是想尽可能避免线上发生故障。「最好的消息，就是没有消息。」 减少故障出现概率，增强系统可用性，降低故障处理时间是 SRE 的最大课题。 在这里有最常用的两个手段，一个是优化性能，一个是做好容量规划和扩展。 这里我着重讨论后者「容量规划」。</p>
<figure>
<img alt="看我的一堆报警消息" src="https://4ocf5n.dijingchao.com/upload_dropbox/201606/message.png"/><figcaption>看我的一堆报警消息</figcaption>
</figure>
<p>^ 看我的一堆报警消息</p>
<!-- more -->
<h2 id="面临的问题">面临的问题</h2>
<p>面对暴涨流量，一边是业务方的满心欢喜，一边就是工程师的烦恼和压力了。 也许是一个受欢迎的功能上线了，或者是某个社会活动导致流量爆发，系统开始出现高延迟，磁盘 IO 不够用了。 也许是 DB 第一个倒下，也许是 RPC 系统第一个倒下&hellip;&hellip; 呃，大神可能会说，我艹，RPC 系统第一个倒下还搞个屁啊，赶紧倒闭算了。</p>
<p>核心的问题就是，在现有性能下面，在面临可能的大流量冲击时候，如何做到不慌不忙，能够 handle 住突如其来的流量？</p>
<h2 id="设定容量目标">设定容量目标</h2>
<p>在解决这个问题之前，我们得先考虑清楚，我们到底要多强的流量处理能力。 如果今天我们只是一个两三台服务器的小团队，却企图设计一个能够抗住 1 亿 pv 访问的系统， 显然是不现实的，至少是不经济的。</p>
<p>衡量系统容量的指标可以简化为在什么流量下面，提供什么样的可用性保证。 一个实际的样例是，在 1 亿 pv 下面，提供 99.99% 的可用性， 其可用性的评判标准是「服务器在 200ms 内返回正确的数据」。</p>
<p>这里有一个重要的概念，可用性保证，术语是服务等级协议（SLA）。 这个指标可以从大部分标准云供应商的标准条款里看到，比如我司机房供应商提供的可用性保证是 99.9%。 阿里云 ECS 的 SLA 是「99.95%」，统计周期是 1 个月 （如果故障时间低于 5 min，不计入故障时间，云供应商都这样，特别霸权）。</p>
<p>一个对 SLA 的直观认识是（具体数据来自 <a href="https://en.wikipedia.org/wiki/High_availability#Percentage_calculation">High availability - Wikipedia, the free encyclopedia</a>）：</p>
<ul>
<li>99.0% 意味着一年有 87 天不可用</li>
<li>99.5% 意味着一年 1.83 天不可用</li>
<li>99.9% 意味着一年 8.76 小时不可用</li>
<li>99.99% 意味着一年 52.56 分钟不可用</li>
<li>99.999% 意味着一年 5 分 15 秒不可用，这是高可用的一般标准</li>
</ul>
<p>设定越高的 SLA 的成本越高，具体 SLA 的设定是成本、收益、期望的平衡。 不同的业务需要的 SLA 也不一样，一般认为 99.9% 基本可用，99.99% 可用性较高， 99.999% 为高可用。</p>
<p>有些云供应商号称 8 个 9，9 个 9，那往往都是对于存储服务里面的数据不丢失这个指标。 除了忽悠忽悠人，这个 SLA 没什么用的。</p>
<h2 id="测量">测量</h2>
<p>做一件伟大事情时候，先有目标，下一步如果是迈出脚步出去闯荡，那么往往换来的是一个身心疲惫的自己。 更稳当的做法是，先摸摸清楚，自己有几把刷子，是不是还要再练练，有没有资格上战场。 没有 Profiling，就是瞎子，根本不用谈优化和容量规划。</p>
<p>对于一般的业务场景而言，常见的测量指标分为三类：</p>
<ul>
<li>服务器的硬件指标（CPU、内存、硬盘 IO、硬盘容量、网络）</li>
<li>服务的软件指标（QPS / latency / pool）</li>
<li>业务的数据指标（核心业务指标，比如注册数，核心动作次数）</li>
</ul>
<p>我司的实践情况是这样的，我们使用 Zabbix 测量服务器，用自己设计的系统收集服务数据，使用 Grafana 呈现。 后者被设计到 RPC 系统内部，数据是全量收集。 我司在业务层面的数据监控做的还不足，这种不足不仅仅体现在数据的全面性上面，还体现在相关成员（比如产品汪）对数据的利用率上面。</p>
<p>除了测量线上的实施数据，了解某个设施的性能极限也是很重要，目前常见的测量方式是：</p>
<ul>
<li>模拟流量进行测试</li>
<li>在线上进行测试，并实时跟踪进展情况，出现异常时候，停止流量切入</li>
<li>从线上引入流量到测试环境进行测试</li>
</ul>
<p>我发现，第一种方法往往不准，第三种方法对于小团队来说，成本太高。第二种方法是最粗暴和有效的。</p>
<h2 id="预警和提醒">预警和提醒</h2>
<p>仅仅知道当前系统的性能表现是不足的，重要的如何将这些数据利用起来，对未来系统增长进行预估。 流量增长 vs 资源消耗，这个曲线大部分情况是线性的，有些情况确实指数增长的。</p>
<p>常见的做法是，给核心指标设置一个阈值（比如 80% 磁盘使用率，40% 磁盘 IO 利用率），当监控的数据到达这个阈值时候。 就必须进行容量扩充，进行负载均衡。</p>
<p>一个从运维同学身上学到的是，提前采购一些设备放到机房里面，比如硬盘、内存，别到时候供应商来不及供货。 必要库存可以降低 MTBF。</p>
<p>除了设定阈值报警，应当定期跑一些脚本获得数据。定期检查报警系统，避免报警系统失效。</p>
<h2 id="必选项---scalable">必选项 - Scalable</h2>
<p>上文写到，「必要时候进行容量扩充，进行负载均衡」。 这点的提出，意味这需要<strong>保证基础设施是可扩展的，支持负载均衡，支持硬件扩容</strong>。</p>
<p>Web 系统比较容易做到横向扩容，使用 Nginx / LVS 等负载均衡即可。 中间件服务一般也是在设计时候就考虑了扩展。（什么？你们家 RPC 系统设计调用不支持扩展？什么脑残设计？！）</p>
<p>DB 级别的服务，往往就要花一些心思了，一些技术（比如 MySQL）想要做到横向扩展， 需要进行提前设计。而一些设施虽然容易进行扩展，比如 ES / Kafka 等现代化设施， 但在部署的时候仍然要进行一些提前准备。</p>
<p>除了提前做好 Scalable，还有几个和部署相关的 tips 可以供参考：</p>
<ul>
<li>使用工具：自动化部署，现在有太多工具可以供选择，比如 ansible 就是一个很好的工具</li>
<li>automatic everything：避免登录服务器操作才能保证未来自动化</li>
<li>工程化：用最佳实践去维护部署系统，用工程化的态度去写部署代码</li>
<li>保持同质，避免花样：避免使用 shell 级别的操作原语操作部署系统，使用预设的 module 去操作</li>
</ul>
<h2 id="end">End</h2>
<p>好了，现在去预测一下当大流量来临之际，你的服务会在哪些环节失败。 想不出来的话，就一点点去测量各个环节性能，然后做一把容量规划吧。</p>
<p>调优和增加容量，这是两个手段，这两个手段互相作用，互相影响。使用时候需要根据成本和收益进行选择。</p>
<p>关于容量规划的更多细节，可以看看 <a href="https://book.douban.com/subject/4200645/">Web容量规划的艺术 (豆瓣)</a> 这里看看。只是这本书写在 2010 年，并且作者介绍的过于传统运维视角一些。</p>

            </div>
            <!-- /.entry-content -->
              
<hr>
<div class="panel">
<div class="panel-body">
   <small>原文链接: <a href="https://blog.alswl.com/2016/06/capacity-planning/">https://blog.alswl.com/2016/06/capacity-planning/</a></small><br>
   <small>3a1ff193cee606bd1e2ea554a16353ee</small><br>
   <small>欢迎关注我的微信公众号：<a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&wechat_redirect">窥豹</a></small><br>
   <small><img src="https://4ocf5n.dijingchao.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/></small>
   <small><img src="https://4ocf5n.dijingchao.com/upload_dropbox/meta/wechat-pay-s-crop.png"/></small>
</div>
</div>

        </article>
    </section>

        </div>
        <div class="col-lg-3 col-lg-offset-2" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="https://blog.alswl.com/atom.xml"><i class="fa fa-rss-square fa-lg"></i> RSS</a></li>
                    <li class="list-group-item"><a href="https://twitter.com/alswl"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/alswl"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                    <li class="list-group-item"><a href="http://weibo.com/alswlx"><i class="fa fa-weibo fa-lg"></i> Weibo</a></li>
                  </ul>
                </li>




        </ul>
    </section>

</aside>        </div>
    <div class="col-lg-3" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="http://127.0.0.1:8000/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                    <ul class="list-group" id="categories">
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/coding/">
                                <i class="fa fa-folder-open fa-lg"></i> Coding
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/efficiency/">
                                <i class="fa fa-folder-open fa-lg"></i> Efficiency
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/fun/">
                                <i class="fa fa-folder-open fa-lg"></i> Fun
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/internet/">
                                <i class="fa fa-folder-open fa-lg"></i> Internet
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/life/">
                                <i class="fa fa-folder-open fa-lg"></i> Life
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/managment/">
                                <i class="fa fa-folder-open fa-lg"></i> Managment
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/thinking/">
                                <i class="fa fa-folder-open fa-lg"></i> Thinking
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/ui/">
                                <i class="fa fa-folder-open fa-lg"></i> UI
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://127.0.0.1:8000/category/viewpoint/">
                                <i class="fa fa-folder-open fa-lg"></i> Viewpoint
                            </a>
                        </li>
                    </ul>
                </li>


        </ul>
    </section>

</aside>    </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2005-2020 alswl
            &middot; Powered by <a href="https://github.com/alswl/pelican-bootstrap3" target="_blank" style="font-weight: bold">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank" style="font-weight: bold">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank" style="font-weight: bold">Bootstrap</a>,
            <p>
              <small> <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license"><img alt="Creative Commons License" style="border-width:0" src="https://4ocf5n.dijingchao.com/upload_dropbox/meta/by-nc-nd_4-0_80x15.png"></a> Content licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" rel="license">Creative Commons Attribution 4.0 International-NonCommercial-NoDerivatives License</a>, except where indicated otherwise. </small>
            </p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8822123-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->
</body>
</html>